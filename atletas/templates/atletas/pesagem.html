{% load static %}

{% extends 'atletas/base.html' %}

{% block title %}Pesagem - Sistema de Gest√£o de Competi√ß√µes de Jud√¥{% endblock %}

{% block extra_css %}
<style>
@media print {
    @page {
        size: A4 landscape;
        margin: 10mm;
    }

    body {
        background: #ffffff !important;
        padding: 0;
    }

    .sidebar,
    .navbar,
    .page-header,
    .filter-box,
    .btn,
    #modal-remanejamento,
    script,
    .sidebar-overlay {
        display: none !important;
    }

    .main-content {
        margin-left: 0 !important;
    }

    .content-wrapper {
        padding: 0 !important;
    }

    .table-container {
        border: none !important;
        box-shadow: none !important;
    }
}

.form-pesagem-inline {
    display: flex;
    gap: var(--spacing-2);
    align-items: center;
    flex-wrap: wrap;
}

.input-peso-inline {
    width: 120px;
    min-width: 100px;
}

/* Modal usa CSS padr√£o do base.html - z-index 1055/1056 */
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-4);">
    <div>
        <h1 class="page-title">Pesagem</h1>
        <p class="page-description">Registre o peso oficial dos atletas inscritos no evento</p>
    </div>
    <div style="display: flex; gap: var(--spacing-3); align-items: center;">
        <button type="button" class="btn btn-secondary" onclick="window.print()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            Imprimir
        </button>
    </div>
</div>

<!-- Seletor de Evento -->
{% if campeonatos %}
<div class="card mb-6" style="background: var(--color-primary-light); border-color: var(--color-primary);">
    <div class="card-body">
        <form method="get" style="display: flex; align-items: center; gap: var(--spacing-4); flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                <label class="form-label" for="campeonato_id" style="font-weight: 600; color: var(--color-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    Selecionar Evento
                </label>
                <select id="campeonato_id" name="campeonato_id" class="form-select" onchange="this.form.submit()" style="font-weight: 500;">
                    {% if campeonato_selecionado %}
                        <option value="{{ campeonato_selecionado.id }}" selected>{{ campeonato_selecionado.nome }}{% if campeonato_selecionado.data_competicao %} - {{ campeonato_selecionado.data_competicao|date:"d/m/Y" }}{% endif %}</option>
                    {% else %}
                        <option value="">-- Selecione um evento --</option>
                    {% endif %}
                    {% for campeonato in campeonatos %}
                        {% if campeonato.id != campeonato_selecionado.id %}
                        <option value="{{ campeonato.id }}">{{ campeonato.nome }}{% if campeonato.data_competicao %} - {{ campeonato.data_competicao|date:"d/m/Y" }}{% endif %}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            {% if classe_filtro or sexo_filtro or categoria_filtro %}
                <input type="hidden" name="classe" value="{{ classe_filtro }}">
                <input type="hidden" name="sexo" value="{{ sexo_filtro }}">
                <input type="hidden" name="categoria" value="{{ categoria_filtro }}">
            {% endif %}
        </form>
        {% if campeonato_selecionado %}
        <div style="margin-top: var(--spacing-3); padding-top: var(--spacing-3); border-top: 1px solid rgba(59, 130, 246, 0.2);">
            <div style="display: flex; align-items: center; gap: var(--spacing-2); font-size: var(--font-size-sm); color: var(--color-gray-700);">
                <strong>Evento selecionado:</strong> {{ campeonato_selecionado.nome }}
                {% if campeonato_selecionado.data_competicao %}
                    <span style="color: var(--color-gray-500);">‚Ä¢</span>
                    <span>{{ campeonato_selecionado.data_competicao|date:"d/m/Y" }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if not campeonato_selecionado %}
<div class="card">
    <div class="empty-state" style="padding: var(--spacing-12);">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto var(--spacing-4); color: var(--color-gray-400);">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
        </svg>
        <div class="empty-state-title">Selecione um evento</div>
        <div class="empty-state-description">Escolha um evento acima para visualizar e registrar as pesagens</div>
    </div>
</div>
{% else %}

<!-- Filtros -->
<div class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">Filtros</h3>
    </div>
    <div class="card-body">
        <form method="get">
            {% if campeonato_selecionado %}
            <input type="hidden" name="campeonato_id" value="{{ campeonato_selecionado.id }}">
            {% endif %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="classe">Classe</label>
                    <select id="classe" name="classe" class="form-select">
                        <option value="">Todas</option>
                        {% for classe in classes %}
                        <option value="{{ classe }}" {% if classe == classe_filtro %}selected{% endif %}>{{ classe }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" class="form-select">
                        <option value="">Todos</option>
                        <option value="M" {% if sexo_filtro == 'M' %}selected{% endif %}>Masculino</option>
                        <option value="F" {% if sexo_filtro == 'F' %}selected{% endif %}>Feminino</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="categoria">Categoria</label>
                    <select id="categoria" name="categoria" class="form-select">
                        <option value="">Todas</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria }}" {% if categoria == categoria_filtro %}selected{% endif %}>{{ categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: var(--spacing-3); justify-content: flex-end;">
                <a href="{% url 'pesagem' %}{% if campeonato_selecionado %}?campeonato_id={{ campeonato_selecionado.id }}{% endif %}" class="btn btn-secondary">Limpar Filtros</a>
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de Pesagem -->
{% if atletas %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Classe</th>
                <th>Sexo</th>
                <th>Categoria</th>
                <th>Limite (kg)</th>
                <th>Peso Oficial</th>
                <th>Status</th>
                <th style="min-width: 200px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for atleta in atletas %}
            <tr>
                <td>
                    <div style="font-weight: 500; color: var(--color-gray-900);">{{ atleta.nome }}</div>
                    <div style="font-size: var(--font-size-xs); color: var(--color-gray-500);">{{ atleta.academia.nome }}</div>
                </td>
                <td>
                    <span class="badge badge-success">{{ atleta.classe }}</span>
                </td>
                <td>
                    <span class="badge {% if atleta.sexo == 'M' %}badge-success{% else %}badge-warning{% endif %}">
                        {{ atleta.get_sexo_display }}
                    </span>
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-700);">
                    {{ atleta.categoria_ajustada|default:atleta.categoria_nome }}
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                    {% if atleta.limite_categoria and atleta.limite_categoria != '-' %}
                        {{ atleta.limite_categoria }}
                    {% elif atleta.get_limite_categoria and atleta.get_limite_categoria != '-' %}
                        {{ atleta.get_limite_categoria }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-700);">
                    {% if atleta.peso_oficial %}
                        <strong style="color: var(--color-gray-900);">{{ atleta.peso_oficial }}</strong> kg
                    {% else %}
                        <span style="color: var(--color-gray-400);">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if atleta.status == 'OK' %}
                        <span class="badge badge-success">{{ atleta.status }}</span>
                    {% elif atleta.status == 'Fora da Categoria' %}
                        <span class="badge badge-danger">{{ atleta.status }}</span>
                        {% if atleta.motivo_ajuste %}
                            <div style="font-size: var(--font-size-xs); color: var(--color-danger); margin-top: var(--spacing-1);">
                                {{ atleta.motivo_ajuste|truncatewords:10 }}
                            </div>
                        {% endif %}
                    {% elif 'Eliminado' in atleta.status %}
                        <span class="badge badge-danger">{{ atleta.status }}</span>
                        {% if atleta.motivo_ajuste %}
                            <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1);">
                                {{ atleta.motivo_ajuste|truncatewords:10 }}
                            </div>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-warning">{{ atleta.status }}</span>
                    {% endif %}
                    {% if atleta.remanejado %}
                        <div style="margin-top: var(--spacing-1);">
                            <span class="badge" style="background: var(--color-warning-light); color: #92400E; font-size: var(--font-size-xs);">‚ö† Remanejado</span>
                        </div>
                    {% endif %}
                    {% if 'Eliminado' in atleta.status or atleta.remanejado %}
                        {% if atleta.academia.telefone %}
                            <div style="margin-top: var(--spacing-2);">
                                <a href="#" onclick="abrirModalWhatsAppAtleta('{{ atleta.academia.telefone }}', '{{ atleta.academia.nome }}', {{ atleta.academia.id }}, '{{ atleta.nome }}', '{{ atleta.categoria_ajustada|default:atleta.categoria_nome }}', '{{ atleta.get_limite_categoria }}', '{{ atleta.peso_oficial }}', '{% if atleta.remanejado %}remanejamento{% else %}desclassificacao{% endif %}', '{{ atleta.categoria_nome }}'); return false;" class="btn btn-whatsapp" style="padding: var(--spacing-1) var(--spacing-2); font-size: var(--font-size-xs);">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                    WhatsApp
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <form class="form-pesagem-inline" method="post" action="{% url 'registrar_peso' atleta.inscricao_obj.id %}" data-inscricao-id="{{ atleta.inscricao_obj.id }}" data-atleta-id="{{ atleta.id }}">
                        {% csrf_token %}
                        <input type="number" 
                               name="peso_oficial" 
                               step="0.1" 
                               min="0" 
                               placeholder="Peso (kg)" 
                               value="{% if atleta.peso_oficial %}{{ atleta.peso_oficial }}{% endif %}" 
                               class="form-input input-peso-inline" 
                               inputmode="decimal" 
                               required>
                        <input type="text" 
                               name="observacoes" 
                               placeholder="Observa√ß√µes (opcional)" 
                               class="form-input" 
                               style="width: 150px; font-size: var(--font-size-xs);">
                        <button type="submit" class="btn btn-primary" style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-xs); white-space: nowrap;">
                            Registrar
                        </button>
                    </form>
                    {% if 'Pode rebaixar' in atleta.motivo_ajuste %}
                    <div style="margin-top: var(--spacing-2);">
                        <a href="{% url 'rebaixar_categoria' atleta.id %}" class="btn btn-success" style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-xs);">
                            Rebaixar Categoria
                        </a>
                    </div>
                    {% endif %}
                    {% if atleta.historico_pesagens %}
                    <div style="margin-top: var(--spacing-2);">
                        <button type="button" class="btn btn-ghost" style="padding: var(--spacing-1) var(--spacing-2); font-size: var(--font-size-xs);" onclick="toggleHistorico({{ atleta.inscricao_id }})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Hist√≥rico ({{ atleta.historico_pesagens|length }})
                        </button>
                    </div>
                    <div id="historico-{{ atleta.inscricao_id }}" style="display: none; margin-top: var(--spacing-2); padding: var(--spacing-3); background: var(--color-gray-50); border-radius: var(--border-radius-md); border: 1px solid var(--color-gray-200);">
                        <div style="font-weight: 600; font-size: var(--font-size-sm); margin-bottom: var(--spacing-2); color: var(--color-gray-900);">Hist√≥rico de Pesagens:</div>
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                            {% for historico in atleta.historico_pesagens %}
                            <div style="padding: var(--spacing-2); background: var(--color-white); border-radius: var(--border-radius-sm); border-left: 3px solid var(--color-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: var(--spacing-2);">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: var(--font-size-sm); color: var(--color-gray-900);">
                                            {{ historico.peso_registrado }} kg
                                            {% if historico.categoria_ajustada %}
                                                <span style="color: var(--color-gray-600); font-weight: 400;">‚Ä¢ {{ historico.categoria_ajustada }}</span>
                                            {% endif %}
                                        </div>
                                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1);">
                                            {{ historico.data_hora|date:"d/m/Y H:i" }}
                                            {% if historico.pesado_por %}
                                                ‚Ä¢ Por: {{ historico.pesado_por.first_name|default:historico.pesado_por.username }}
                                            {% endif %}
                                        </div>
                                        {% if historico.motivo_ajuste %}
                                        <div style="font-size: var(--font-size-xs); color: var(--color-warning); margin-top: var(--spacing-1);">
                                            {{ historico.motivo_ajuste }}
                                        </div>
                                        {% endif %}
                                        {% if historico.observacoes %}
                                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1); font-style: italic;">
                                            {{ historico.observacoes }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <div class="empty-state-title">Nenhum atleta encontrado</div>
        <div class="empty-state-description">
            {% if classe_filtro or sexo_filtro or categoria_filtro %}
                Nenhum atleta corresponde aos filtros aplicados.
            {% else %}
                Ainda n√£o h√° atletas cadastrados para pesagem.
            {% endif %}
        </div>
        {% if not classe_filtro and not sexo_filtro and not categoria_filtro %}
        <a href="{% url 'cadastrar_atleta' %}" class="btn btn-primary">Cadastrar Atleta</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- Modal de Confirma√ß√£o de Remanejamento - PADR√ÉO SHIAI (FORA DO BLOCO PARA GARANTIR VISIBILIDADE) -->
<div class="modal-overlay" id="modal-remanejamento">
    <div class="modal">
        <div class="modal-header" style="padding: var(--spacing-6); border-bottom: 1px solid var(--color-gray-200); display: flex; align-items: center; justify-content: space-between;">
            <h3 class="modal-title" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-gray-900); margin: 0;">‚ö†Ô∏è Aten√ß√£o: Peso fora da categoria!</h3>
            <button class="modal-close" onclick="fecharModal()" style="width: 32px; height: 32px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-sm); transition: all var(--transition-base);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; color: var(--color-gray-500);">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body" style="padding: var(--spacing-6);">
            <div id="modal-conteudo">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
        </div>
        <div class="modal-footer" style="padding: var(--spacing-6); border-top: 1px solid var(--color-gray-200);">
            <form id="form-confirmacao" method="post" style="width: 100%;">
                {% csrf_token %}
                <input type="hidden" name="peso_oficial" id="modal-peso">
                <input type="hidden" name="categoria_nova" id="modal-categoria-nova">
                <div style="display: flex; gap: var(--spacing-3); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btn-desclassificar">Desclassificar</button>
                    <button type="submit" name="acao" value="remanejar" class="btn btn-success">Remanejar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.form-pesagem-inline');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const inscricaoId = this.dataset.inscricaoId;
            const btnSubmit = this.querySelector('button[type="submit"]');
            const originalText = btnSubmit.textContent;
            
            // Loading state
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Salvando...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('=== RESPOSTA DO SERVIDOR ===');
                console.log('Resposta completa:', JSON.stringify(data, null, 2));
                console.log('success:', data.success);
                console.log('precisa_confirmacao:', data.precisa_confirmacao, 'tipo:', typeof data.precisa_confirmacao);
                console.log('categoria_ok:', data.categoria_ok);
                console.log('categoria_nova:', data.categoria_nova);
                
                if (data.success) {
                    // Verificar se precisa confirma√ß√£o (pode ser true, 'true', ou 1)
                    const precisaConfirmacao = data.precisa_confirmacao === true || 
                                              data.precisa_confirmacao === 'true' || 
                                              data.precisa_confirmacao === 1 ||
                                              (data.precisa_confirmacao && !data.categoria_ok);
                    
                    console.log('Precisa confirma√ß√£o calculado:', precisaConfirmacao);
                    
                    if (precisaConfirmacao) {
                        // Mostrar modal de confirma√ß√£o para remanejamento
                        console.log('>>> ABRINDO MODAL <<<');
                        
                        // Garantir que temos os dados necess√°rios
                        const modalData = {
                            ...data,
                            categoria_nova: data.categoria_nova || 'N√£o dispon√≠vel',
                            limite_atual_min: data.limite_atual_min || 0,
                            limite_atual_max: data.limite_atual_max || 999,
                            limite_novo_min: data.limite_novo_min || 0,
                            limite_novo_max: data.limite_novo_max || 0
                        };
                        
                        console.log('Dados para o modal:', modalData);
                        
                        try {
                            mostrarModalRemanejamento(modalData);
                            console.log('Modal chamado com sucesso');
                        } catch (error) {
                            console.error('Erro ao chamar mostrarModalRemanejamento:', error);
                            alert('Erro ao abrir modal. Verifique o console para mais detalhes.');
                        }
                        
                        btnSubmit.disabled = false;
                        btnSubmit.textContent = originalText;
                    } else {
                        // Peso registrado com sucesso - recarregar p√°gina para atualizar
                        if (data.categoria_ok) {
                            alert('Peso registrado com sucesso!');
                        } else {
                            alert('Peso registrado, mas est√° fora dos limites da categoria. Verifique o status.');
                        }
                        window.location.reload();
                    }
                } else {
                    alert(data.message || 'Erro ao registrar peso.');
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                btnSubmit.disabled = false;
                btnSubmit.textContent = originalText;
                window.location.reload();
            });
        });
    });
});

function mostrarModalRemanejamento(data) {
    console.log('mostrarModalRemanejamento chamado com:', data);
    const modal = document.getElementById('modal-remanejamento');
    const conteudo = document.getElementById('modal-conteudo');
    const form = document.getElementById('form-confirmacao');
    
    if (!modal) {
        console.error('Modal n√£o encontrado! ID: modal-remanejamento');
        alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
        return;
    }
    
    if (!conteudo) {
        console.error('Conte√∫do do modal n√£o encontrado! ID: modal-conteudo');
        alert('Erro: Conte√∫do do modal n√£o encontrado. Recarregue a p√°gina.');
        return;
    }
    
    if (!form) {
        console.error('Formul√°rio n√£o encontrado! ID: form-confirmacao');
        alert('Erro: Formul√°rio n√£o encontrado. Recarregue a p√°gina.');
        return;
    }
    
    console.log('Elementos do modal encontrados, configurando...');
    console.log('Modal element:', modal);
    console.log('Modal parent:', modal.parentElement);
    console.log('Modal computed style before:', window.getComputedStyle(modal).display);
    
    form.action = `/pesagem/inscricao/${data.inscricao_id}/confirmar-remanejamento/`;
    const pesoInput = document.getElementById('modal-peso');
    const categoriaInput = document.getElementById('modal-categoria-nova');
    
    if (pesoInput) pesoInput.value = data.peso;
    if (categoriaInput) categoriaInput.value = data.categoria_nova || '';
    
    // Verificar se o modal est√° no DOM e vis√≠vel
    if (!document.body.contains(modal)) {
        console.error('ERRO CR√çTICO: Modal n√£o est√° no DOM!');
        alert('Erro: Modal n√£o encontrado no DOM. Recarregue a p√°gina.');
        return;
    }
    
    const limiteAtual = data.limite_atual_max ? 
        `${data.limite_atual_min} a ${data.limite_atual_max} kg` : 
        `${data.limite_atual_min} kg ou mais`;
    
    const limiteNovo = data.limite_novo_max ? 
        `${data.limite_novo_min} a ${data.limite_novo_max} kg` : 
        `${data.limite_novo_min} kg ou mais`;
    
    conteudo.innerHTML = `
        <div style="margin-bottom: var(--spacing-4);">
            <p style="margin-bottom: var(--spacing-2);"><strong>Atleta:</strong> <span style="color: var(--color-gray-900);">${data.atleta_nome}</span></p>
            <p style="margin-bottom: var(--spacing-2);"><strong>Peso registrado:</strong> <span style="color: var(--color-primary); font-weight: 600;">${data.peso} kg</span></p>
        </div>
        <div style="border-top: 1px solid var(--color-gray-200); border-bottom: 1px solid var(--color-gray-200); padding: var(--spacing-4) 0; margin: var(--spacing-4) 0;">
            <p style="margin-bottom: var(--spacing-2);"><strong>Categoria atual:</strong> ${data.categoria_atual}</p>
            <p style="margin-bottom: var(--spacing-2); color: var(--color-gray-600);">Limite: ${limiteAtual}</p>
            <p style="margin-top: var(--spacing-3); margin-bottom: var(--spacing-2);"><strong>Categoria sugerida:</strong> <span style="color: var(--color-success);">${data.categoria_nova}</span></p>
            <p style="color: var(--color-gray-600);">Limite: ${limiteNovo}</p>
        </div>
        <div style="background: var(--color-danger-light); border: 1px solid var(--color-danger); border-radius: var(--border-radius-md); padding: var(--spacing-4);">
            <p style="color: #991B1B; font-weight: 600; margin-bottom: var(--spacing-2);">‚ö†Ô∏è IMPORTANTE:</p>
            <ul style="margin: 0; padding-left: var(--spacing-5); color: #991B1B;">
                <li style="margin-bottom: var(--spacing-1);">Se <strong>Remanejar</strong>: O atleta ser√° remanejado para a nova categoria e a academia <strong>perder√° 1 ponto</strong>.</li>
                <li>Se <strong>Desclassificar</strong>: O atleta ser√° desclassificado por estar fora do peso da categoria.</li>
            </ul>
        </div>
    `;
    
    console.log('Conte√∫do do modal configurado, mostrando modal...');
    
    // Prevenir scroll do body quando modal abrir
    document.body.style.overflow = 'hidden';
    
    // Adicionar classe 'active'
    modal.classList.add('active');
    
    // FOR√áAR exibi√ß√£o do modal (solu√ß√£o robusta para conflitos de CSS)
    setTimeout(() => {
        const computedStyle = window.getComputedStyle(modal);
        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
            console.warn('‚ö†Ô∏è CSS n√£o aplicado corretamente, for√ßando exibi√ß√£o...');
            modal.style.setProperty('display', 'flex', 'important');
            modal.style.setProperty('visibility', 'visible', 'important');
            modal.style.setProperty('opacity', '1', 'important');
            modal.style.setProperty('z-index', '1055', 'important');
        }
        
        // Garantir que o modal interno tamb√©m est√° vis√≠vel
        const modalInner = modal.querySelector('.modal');
        if (modalInner) {
            modalInner.style.setProperty('display', 'block', 'important');
            modalInner.style.setProperty('visibility', 'visible', 'important');
            modalInner.style.setProperty('opacity', '1', 'important');
            modalInner.style.setProperty('z-index', '1056', 'important');
        }
    }, 10);
    
    console.log('‚úÖ Modal ativado com classe "active"');
    
    // Remover listeners anteriores e adicionar novo
    const btnDesclassificar = document.getElementById('btn-desclassificar');
    const novoBtn = btnDesclassificar.cloneNode(true);
    btnDesclassificar.parentNode.replaceChild(novoBtn, btnDesclassificar);
    
    novoBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        formData.append('acao', 'desclassificar');
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(() => {
            window.location.reload();
        });
    });
}

function fecharModal() {
    const modal = document.getElementById('modal-remanejamento');
    if (modal) {
        modal.classList.remove('active');
        // Restaurar scroll do body
        document.body.style.overflow = '';
        
        console.log('Modal fechado');
    }
}

function toggleHistorico(inscricaoId) {
    const historicoDiv = document.getElementById('historico-' + inscricaoId);
    if (historicoDiv) {
        historicoDiv.style.display = historicoDiv.style.display === 'none' ? 'block' : 'none';
    }
}

// Fechar modal ao clicar no overlay (evitar propaga√ß√£o no conte√∫do do modal)
document.addEventListener('DOMContentLoaded', function() {
    const modalOverlay = document.getElementById('modal-remanejamento');
    if (modalOverlay) {
        modalOverlay.addEventListener('click', function(e) {
            // S√≥ fechar se clicar diretamente no overlay, n√£o no conte√∫do do modal
            if (e.target === modalOverlay) {
                fecharModal();
            }
        });
        
        // Prevenir fechamento ao clicar no conte√∫do do modal
        const modalContent = modalOverlay.querySelector('.modal');
        if (modalContent) {
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    }
});

// Fun√ß√£o para abrir modal WhatsApp com dados do atleta
function abrirModalWhatsAppAtleta(telefone, nomeAcademia, academiaId, nomeAtleta, categoriaAtual, limiteCategoria, pesoAtleta, tipoNotificacao, categoriaOriginal) {
    const dadosAtleta = {
        nome: nomeAtleta,
        categoria: categoriaAtual,
        limite: limiteCategoria,
        peso: pesoAtleta,
        categoria_original: categoriaOriginal,
        categoria_nova: categoriaAtual
    };
    
    // Se j√° existe a fun√ß√£o global, usar ela
    if (typeof abrirModalWhatsApp === 'function') {
        abrirModalWhatsApp(telefone, nomeAcademia, academiaId, 'atleta', dadosAtleta);
        // Selecionar o tema correto
        setTimeout(() => {
            const tema = tipoNotificacao === 'remanejamento' ? 'remanejamento' : 'desclassificacao';
            const radio = document.querySelector(`input[name="tema-mensagem"][value="${tema}"]`);
            if (radio) {
                radio.checked = true;
                if (typeof atualizarMensagem === 'function') {
                    atualizarMensagem();
                }
            }
        }, 100);
    } else {
        // Carregar modal dinamicamente
        carregarModalWhatsApp().then(() => {
            abrirModalWhatsApp(telefone, nomeAcademia, academiaId, 'atleta', dadosAtleta);
            setTimeout(() => {
                const tema = tipoNotificacao === 'remanejamento' ? 'remanejamento' : 'desclassificacao';
                const radio = document.querySelector(`input[name="tema-mensagem"][value="${tema}"]`);
                if (radio) {
                    radio.checked = true;
                    atualizarMensagem();
                }
            }, 100);
        });
    }
}

// Carregar modal WhatsApp dinamicamente se n√£o estiver na p√°gina
function carregarModalWhatsApp() {
    return new Promise((resolve) => {
        if (document.getElementById('modal-whatsapp')) {
            resolve();
            return;
        }
        
        // Carregar o modal da lista de academias via fetch ou criar inline
        const modalHTML = `
            <!-- Modal WhatsApp -->
            <div class="modal-overlay" id="modal-whatsapp">
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <svg viewBox="0 0 24 24" fill="#25D366" style="width: 24px; height: 24px; vertical-align: middle; margin-right: var(--spacing-2);">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Enviar Mensagem WhatsApp
                        </h3>
                        <button class="modal-close" onclick="fecharModalWhatsApp()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group mb-4">
                            <label class="form-label">Destinat√°rio</label>
                            <div style="padding: var(--spacing-3); background: var(--color-gray-50); border-radius: var(--border-radius-md);">
                                <strong id="whatsapp-destinatario"></strong>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label">Tema da Mensagem</label>
                            <div style="display: grid; gap: var(--spacing-2);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="convite" checked onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">üì¢ Convite para a Copa</div>
                                        <small style="color: var(--color-gray-500);">Mensagem de convite para participar do campeonato</small>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="desclassificacao" onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">‚ö†Ô∏è Atleta Fora do Peso - Desclassifica√ß√£o</div>
                                        <small style="color: var(--color-gray-500);">Informar sobre desclassifica√ß√£o por peso</small>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="remanejamento" onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">üîÑ Atleta Fora do Peso - Remanejamento</div>
                                        <small style="color: var(--color-gray-500);">Informar sobre remanejamento e perda de 1 ponto</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label" for="whatsapp-mensagem">Mensagem</label>
                            <textarea id="whatsapp-mensagem" class="form-textarea" rows="8" oninput="contarCaracteres()"></textarea>
                            <small style="display: block; margin-top: var(--spacing-1); color: var(--color-gray-500); font-size: var(--font-size-xs);">
                                Voc√™ pode editar a mensagem antes de enviar. 
                                <span id="contador-caracteres">0</span> caracteres
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fecharModalWhatsApp()">Cancelar</button>
                        <button class="btn btn-whatsapp" onclick="abrirWhatsApp()" style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Abrir WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        inicializarFuncoesWhatsApp();
        resolve();
    });
}

// Inicializar fun√ß√µes do WhatsApp se n√£o existirem
function inicializarFuncoesWhatsApp() {
    if (typeof window.whatsappData === 'undefined') {
        window.whatsappData = {
            telefone: '',
            nome: '',
            academiaId: null,
            tipo: 'academia',
            dadosAtleta: null
        };
    }
    
    if (typeof window.abrirModalWhatsApp === 'undefined') {
        window.abrirModalWhatsApp = function(telefone, nome, academiaId = null, tipo = 'academia', dadosAtleta = null) {
            window.whatsappData.telefone = telefone;
            window.whatsappData.nome = nome;
            window.whatsappData.academiaId = academiaId;
            window.whatsappData.tipo = tipo;
            window.whatsappData.dadosAtleta = dadosAtleta;
            
            document.getElementById('whatsapp-destinatario').textContent = `${nome} (${telefone})`;
            
            const radioConvite = document.querySelector('input[name="tema-mensagem"][value="convite"]');
            if (radioConvite) radioConvite.checked = true;
            
            atualizarMensagem();
            document.getElementById('modal-whatsapp').classList.add('active');
        };
    }
    
    if (typeof window.fecharModalWhatsApp === 'undefined') {
        window.fecharModalWhatsApp = function() {
            document.getElementById('modal-whatsapp').classList.remove('active');
        };
    }
    
    if (typeof window.contarCaracteres === 'undefined') {
        window.contarCaracteres = function() {
            const textarea = document.getElementById('whatsapp-mensagem');
            const contador = document.getElementById('contador-caracteres');
            if (textarea && contador) {
                contador.textContent = textarea.value.length;
            }
        };
    }
    
    if (typeof window.atualizarMensagem === 'undefined') {
        window.atualizarMensagem = function() {
            const tema = document.querySelector('input[name="tema-mensagem"]:checked')?.value || 'convite';
            const textarea = document.getElementById('whatsapp-mensagem');
            if (!textarea) return;
            
            const campeonatoNome = '{% if campeonato_ativo %}{{ campeonato_ativo.nome }}{% else %}Campeonato{% endif %}';
            const campeonatoDataInicio = '{% if campeonato_ativo and campeonato_ativo.data_inicio %}{{ campeonato_ativo.data_inicio|date:"d/m/Y" }}{% endif %}';
            const valorFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_federado %}R$ {{ campeonato_ativo.valor_inscricao_federado|floatformat:2 }}{% else %}-{% endif %}';
            const valorNaoFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_nao_federado %}R$ {{ campeonato_ativo.valor_inscricao_nao_federado|floatformat:2 }}{% else %}-{% endif %}';
            
            let mensagem = '';
            const data = window.whatsappData;
            
            if (tema === 'convite') {
                mensagem = `ü•ã *Convite para ${campeonatoNome}*\\n\\n`;
                mensagem += `Ol√°! ${data.nome}\\n\\n`;
                mensagem += `Gostar√≠amos de convidar sua academia para participar do *${campeonatoNome}*.\\n\\n`;
                if (campeonatoDataInicio) {
                    mensagem += `üìÖ *Data:* ${campeonatoDataInicio}\\n`;
                }
                mensagem += `\\nüí∞ *Valores de Inscri√ß√£o:*\\n`;
                mensagem += `‚Ä¢ Federado: ${valorFederado}\\n`;
                mensagem += `‚Ä¢ N√£o Federado: ${valorNaoFederado}\\n\\n`;
                mensagem += `Contamos com a participa√ß√£o de voc√™s!\\n\\n`;
                mensagem += `Para mais informa√ß√µes, entre em contato.`;
            } else if (tema === 'desclassificacao') {
                if (data.tipo === 'atleta' && data.dadosAtleta) {
                    const atleta = data.dadosAtleta;
                    mensagem = `‚ö†Ô∏è *Atleta Fora do Peso - Desclassifica√ß√£o*\\n\\n`;
                    mensagem += `Ol√°! Professor da ${data.nome}\\n\\n`;
                    mensagem += `Informamos que o atleta *${atleta.nome}* foi *DESCLASSIFICADO* por estar fora do peso da categoria.\\n\\n`;
                    mensagem += `üìã *Detalhes:*\\n`;
                    mensagem += `‚Ä¢ Atleta: ${atleta.nome}\\n`;
                    mensagem += `‚Ä¢ Categoria: ${atleta.categoria}\\n`;
                    mensagem += `‚Ä¢ Limite da categoria: ${atleta.limite}\\n`;
                    mensagem += `‚Ä¢ Peso registrado: ${atleta.peso} kg\\n\\n`;
                    mensagem += `O atleta est√° fora dos limites permitidos e n√£o poder√° competir nesta categoria.\\n\\n`;
                    mensagem += `Em caso de d√∫vidas, entre em contato conosco.`;
                } else {
                    mensagem = `‚ö†Ô∏è *Atleta Fora do Peso - Desclassifica√ß√£o*\\n\\n`;
                    mensagem += `Ol√°! ${data.nome}\\n\\n`;
                    mensagem += `Informamos que um atleta de sua academia foi *DESCLASSIFICADO* por estar fora do peso da categoria.\\n\\n`;
                    mensagem += `O atleta n√£o poder√° competir nesta categoria.\\n\\n`;
                    mensagem += `Para mais detalhes, acesse o sistema ou entre em contato.`;
                }
            } else if (tema === 'remanejamento') {
                if (data.tipo === 'atleta' && data.dadosAtleta) {
                    const atleta = data.dadosAtleta;
                    mensagem = `üîÑ *Atleta Fora do Peso - Remanejamento*\\n\\n`;
                    mensagem += `Ol√°! Professor da ${data.nome}\\n\\n`;
                    mensagem += `Informamos que o atleta *${atleta.nome}* foi *REMANEJADO* para outra categoria.\\n\\n`;
                    mensagem += `üìã *Detalhes:*\\n`;
                    mensagem += `‚Ä¢ Atleta: ${atleta.nome}\\n`;
                    mensagem += `‚Ä¢ Categoria original: ${atleta.categoria_original}\\n`;
                    mensagem += `‚Ä¢ Nova categoria: ${atleta.categoria_nova}\\n`;
                    mensagem += `‚Ä¢ Peso registrado: ${atleta.peso} kg\\n\\n`;
                    mensagem += `‚ö†Ô∏è *ATEN√á√ÉO:*\\n`;
                    mensagem += `Como o atleta foi remanejado, a academia *perder√° 1 ponto* no quadro geral de medalhas.\\n\\n`;
                    mensagem += `O atleta poder√° competir na nova categoria, mas este ajuste impacta a pontua√ß√£o da academia.\\n\\n`;
                    mensagem += `Em caso de d√∫vidas, entre em contato conosco.`;
                } else {
                    mensagem = `üîÑ *Atleta Fora do Peso - Remanejamento*\\n\\n`;
                    mensagem += `Ol√°! ${data.nome}\\n\\n`;
                    mensagem += `Informamos que um atleta de sua academia foi *REMANEJADO* para outra categoria.\\n\\n`;
                    mensagem += `‚ö†Ô∏è *ATEN√á√ÉO:*\\n`;
                    mensagem += `Como houve remanejamento, a academia *perder√° 1 ponto* no quadro geral de medalhas.\\n\\n`;
                    mensagem += `O atleta poder√° competir na nova categoria, mas este ajuste impacta a pontua√ß√£o da academia.\\n\\n`;
                    mensagem += `Para mais detalhes, acesse o sistema ou entre em contato.`;
                }
            }
            
            textarea.value = mensagem;
            contarCaracteres();
        };
    }
    
    if (typeof window.abrirWhatsApp === 'undefined') {
        window.abrirWhatsApp = function() {
            const textarea = document.getElementById('whatsapp-mensagem');
            const mensagem = textarea?.value || '';
            
            if (!mensagem.trim()) {
                alert('Por favor, preencha a mensagem antes de enviar.');
                return;
            }
            
            let numero = window.whatsappData.telefone.replace(/\\D/g, '');
            if (numero.length === 11 && numero[0] !== '5') {
                numero = '55' + numero;
            } else if (numero.length === 10) {
                numero = '55' + numero;
            }
            numero = numero.replace(/^550/, '55');
            
            const mensagemEncoded = encodeURIComponent(mensagem);
            const urlWhatsApp = `https://wa.me/${numero}?text=${mensagemEncoded}`;
            window.open(urlWhatsApp, '_blank');
            
            setTimeout(() => {
                fecharModalWhatsApp();
            }, 500);
        };
    }
    
    // Event listeners
    const modal = document.getElementById('modal-whatsapp');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalWhatsApp();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal?.classList.contains('active')) {
            fecharModalWhatsApp();
        }
    });
}
</script>
{% endblock %}
