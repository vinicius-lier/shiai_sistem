
{% extends "atletas/layouts/base_weighing.html" %}
{% load static %}

{% block title %}Pesagem - Sistema de Gest√£o de Competi√ß√µes de Jud√¥{% endblock %}

{% block extra_css %}
<style>
@media print {
    @page {
        size: A4 landscape;
        margin: 10mm;
    }

    body {
        background: #ffffff !important;
        padding: 0;
    }

    .sidebar,
    .navbar,
    .page-header,
    .filter-box,
    .btn,
    #modal-remanejamento,
    script,
    .sidebar-overlay,
    .no-print {
        display: none !important;
    }

    .main-content {
        margin-left: 0 !important;
    }

    .content-wrapper {
        padding: 0 !important;
    }

    .table-container {
        border: none !important;
        box-shadow: none !important;
    }

    .print-only {
        display: block !important;
    }

    .table {
        font-size: 12px;
    }

    .table th,
    .table td {
        padding: 10px 8px !important;
        min-height: 18px;
    }
}

.form-pesagem-inline {
    display: flex;
    gap: var(--spacing-2);
    align-items: center;
    flex-wrap: wrap;
}

.input-peso-inline {
    width: 120px;
    min-width: 100px;
}

/* Modal usa CSS padr√£o do base.html - z-index 1055/1056 */
#modal-remanejamento {
    display: none !important;
}

#modal-remanejamento.active{
    display:flex !important;
    opacity:1 !important;
    visibility:visible !important;
    z-index:1056 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header no-print" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-4);">
    <div>
        <h1 class="page-title">Pesagem</h1>
        <p class="page-description">Registre o peso oficial dos atletas inscritos no evento</p>
    </div>
    <div style="display: flex; gap: var(--spacing-3); align-items: center;">
        <button type="button" class="btn btn-secondary" onclick="window.print()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            Imprimir
        </button>
    </div>
</div>

<!-- Cabe√ßalho do evento -->
{% if campeonato_selecionado %}
<div class="page-header no-print" style="margin-bottom: var(--spacing-6);">
    <h1 class="page-title">{{ campeonato_selecionado.nome }}</h1>
    {% if campeonato_selecionado.data_competicao %}
        <p class="page-description">{{ campeonato_selecionado.data_competicao|date:"d/m/Y" }}</p>
    {% endif %}
</div>
{% endif %}

{% if not campeonato_selecionado %}
<div class="card">
    <div class="empty-state" style="padding: var(--spacing-12);">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto var(--spacing-4); color: var(--color-gray-400);">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
        </svg>
        <div class="empty-state-title">Selecione um evento</div>
        <div class="empty-state-description">Escolha um evento acima para visualizar e registrar as pesagens</div>
    </div>
</div>
{% else %}

<!-- Filtros -->
<div class="card mb-6 no-print">
    <div class="card-header">
        <h3 class="card-title">Filtros</h3>
    </div>
    <div class="card-body">
        <form method="get">
            {% if campeonato_selecionado %}
            <input type="hidden" name="campeonato_id" value="{{ campeonato_selecionado.id }}">
            {% endif %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="classe">Classe</label>
                    <select id="classe" name="classe" class="form-select">
                        <option value="">Todas</option>
                        {% for classe in classes %}
                        <option value="{{ classe }}" {% if classe == classe_filtro %}selected{% endif %}>{{ classe }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" class="form-select">
                        <option value="">Todos</option>
                        <option value="M" {% if sexo_filtro == 'M' %}selected{% endif %}>Masculino</option>
                        <option value="F" {% if sexo_filtro == 'F' %}selected{% endif %}>Feminino</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="categoria">Categoria</label>
                    <select id="categoria" name="categoria" class="form-select">
                        <option value="">Todas</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria }}" {% if categoria == categoria_filtro %}selected{% endif %}>{{ categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="action-row">
                <a href="{% url 'pesagem' request.organizacao.slug %}{% if campeonato_selecionado %}?campeonato_id={{ campeonato_selecionado.id }}{% endif %}" class="btn btn-secondary">Limpar Filtros</a>
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de Pesagem -->
{% if atletas %}
<div class="print-only" style="display:none; margin-bottom:12px; display:flex; align-items:center; gap:12px;">
    <img src="{% static 'atletas/images/logo_black.png' %}" alt="Shiai System" style="height:42px; width:auto; display:block;">
    <div style="font-size:14px; line-height:1.3;">
        <div style="font-weight:700;">Shiai System - Pesagem</div>
        {% if campeonato_selecionado %}
            <div>{{ campeonato_selecionado.nome }}</div>
            {% if campeonato_selecionado.data_competicao %}
                <div>{{ campeonato_selecionado.data_competicao|date:"d/m/Y" }}</div>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Classe</th>
                <th>Sexo</th>
                <th>Categoria</th>
                <th>Limite (kg)</th>
                <th>Peso Real</th>
                <th>Status</th>
                <th style="min-width: 200px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for atleta in atletas %}
            <tr>
                <td>
                    <div style="font-weight: 500; color: var(--color-gray-900);">{{ atleta.nome }}</div>
                    <div style="font-size: var(--font-size-xs); color: var(--color-gray-500);">{{ atleta.academia.nome }}</div>
                </td>
                <td>
                    <span class="badge badge-success">{{ atleta.classe }}</span>
                </td>
                <td>
                    <span class="badge {% if atleta.sexo == 'M' %}badge-success{% else %}badge-warning{% endif %}">
                        {{ atleta.get_sexo_display }}
                    </span>
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-700);">
                    {{ atleta.categoria_real_nome|default:atleta.categoria_ajustada|default:atleta.categoria_nome }}
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                    {{ atleta.limite_categoria_real|default:"-" }}
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-700);">
                    {% if atleta.peso_oficial %}
                        <strong style="color: var(--color-gray-900);">{{ atleta.peso_oficial }}</strong> kg
                    {% else %}
                        <span style="color: var(--color-gray-400);">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if atleta.status_atual == 'aprovado' %}
                        <span class="badge badge-success">{{ atleta.status }}</span>
                    {% elif atleta.status_atual == 'remanejado' %}
                        <span class="badge badge-warning">{{ atleta.status }}</span>
                    {% elif atleta.status_atual == 'desclassificado' %}
                        <span class="badge badge-danger">{{ atleta.status }}</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ atleta.status }}</span>
                    {% endif %}
                    {% if atleta.motivo_ajuste %}
                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1);">
                            {{ atleta.motivo_ajuste|truncatewords:10 }}
                        </div>
                    {% endif %}
                    {% if atleta.status_atual == 'remanejado' or atleta.status_atual == 'desclassificado' %}
                        {% if atleta.academia.telefone %}
                            <div style="margin-top: var(--spacing-2);">
                                <a href="#"
                                   onclick="abrirModalWhatsAppAtleta('{{ atleta.academia.telefone }}', '{{ atleta.academia.nome }}', {{ atleta.academia.id }}, '{{ atleta.nome }}', '{{ atleta.categoria_real_nome|default:atleta.categoria_ajustada|default:atleta.categoria_nome }}', '{{ atleta.limite_categoria_real|default:'' }}', '{{ atleta.peso_real|default:'' }}', '{% if atleta.status_atual == 'remanejado' %}remanejamento{% else %}desclassificacao{% endif %}', '{{ atleta.categoria_nome }}'); return false;"
                                   class="btn btn-whatsapp"
                                   style="padding: var(--spacing-1) var(--spacing-2); font-size: var(--font-size-xs);">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                    WhatsApp
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <form class="form-pesagem-inline js-form-pesagem"
                          method="post"
                          action="{% url 'registrar_peso' request.organizacao.slug atleta.inscricao_obj.id %}"
                          data-inscricao-id="{{ atleta.inscricao_obj.id }}"
                          data-confirm-url="{% url 'confirmar_remanejamento' request.organizacao.slug atleta.inscricao_obj.id %}">
                        {% csrf_token %}
                        <input type="number" 
                               name="peso_oficial" 
                               step="0.1" 
                               min="0" 
                               placeholder="Peso (kg)" 
                               value="{% if atleta.peso_real %}{{ atleta.peso_real }}{% endif %}" 
                               class="form-input input-peso-inline" 
                               inputmode="decimal" 
                               required>
                        <input type="text" 
                               name="observacoes" 
                               placeholder="Observa√ß√µes (opcional)" 
                               class="form-input" 
                               style="width: 150px; font-size: var(--font-size-xs);">
                        <button type="submit" class="btn btn-primary" style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-xs); white-space: nowrap;">
                            Registrar
                        </button>
                    </form>
                    {% if 'Pode rebaixar' in atleta.motivo_ajuste %}
                    <div style="margin-top: var(--spacing-2);">
                        <a href="{% url 'rebaixar_categoria' atleta.id %}" class="btn btn-success" style="padding: var(--spacing-2) var(--spacing-3); font-size: var(--font-size-xs);">
                            Rebaixar Categoria
                        </a>
                    </div>
                    {% endif %}
                    {% if atleta.historico_pesagens %}
                    <div style="margin-top: var(--spacing-2);">
                        <button type="button" class="btn btn-ghost" style="padding: var(--spacing-1) var(--spacing-2); font-size: var(--font-size-xs);" onclick="toggleHistorico({{ atleta.inscricao_id }})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Hist√≥rico ({{ atleta.historico_pesagens|length }})
                        </button>
                    </div>
                    <div id="historico-{{ atleta.inscricao_id }}" style="display: none; margin-top: var(--spacing-2); padding: var(--spacing-3); background: var(--color-gray-50); border-radius: var(--border-radius-md); border: 1px solid var(--color-gray-200);">
                        <div style="font-weight: 600; font-size: var(--font-size-sm); margin-bottom: var(--spacing-2); color: var(--color-gray-900);">Hist√≥rico de Pesagens:</div>
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                            {% for historico in atleta.historico_pesagens %}
                            <div style="padding: var(--spacing-2); background: var(--color-white); border-radius: var(--border-radius-sm); border-left: 3px solid var(--color-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: var(--spacing-2);">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: var(--font-size-sm); color: var(--color-gray-900);">
                                            {{ historico.peso_registrado }} kg
                                            {% if historico.categoria_ajustada %}
                                                <span style="color: var(--color-gray-600); font-weight: 400;">‚Ä¢ {{ historico.categoria_ajustada }}</span>
                                            {% endif %}
                                        </div>
                                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1);">
                                            {{ historico.data_hora|date:"d/m/Y H:i" }}
                                            {% if historico.pesado_por %}
                                                ‚Ä¢ Por: {{ historico.pesado_por.first_name|default:historico.pesado_por.email }}
                                            {% endif %}
                                        </div>
                                        {% if historico.motivo_ajuste %}
                                        <div style="font-size: var(--font-size-xs); color: var(--color-warning); margin-top: var(--spacing-1);">
                                            {{ historico.motivo_ajuste }}
                                        </div>
                                        {% endif %}
                                        {% if historico.observacoes %}
                                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-top: var(--spacing-1); font-style: italic;">
                                            {{ historico.observacoes }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <div class="empty-state-title">Nenhum atleta encontrado</div>
        <div class="empty-state-description">
            {% if classe_filtro or sexo_filtro or categoria_filtro %}
                Nenhum atleta corresponde aos filtros aplicados.
            {% else %}
                Ainda n√£o h√° atletas cadastrados para pesagem.
            {% endif %}
        </div>
        {% if not classe_filtro and not sexo_filtro and not categoria_filtro %}
        <a href="{% url 'cadastrar_atleta' organizacao_slug=request.organizacao.slug %}" class="btn btn-primary">Cadastrar Atleta</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

{% block extra_modals %}
    {% include 'atletas/includes/pesagem_modal.html' with ignored=True %}
{% endblock %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pesagem.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.form-pesagem-inline');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const inscricaoId = this.dataset.inscricaoId;
            const btnSubmit = this.querySelector('button[type="submit"]');
            const originalText = btnSubmit.textContent;
            
            // Loading state
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Salvando...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('=== RESPOSTA DO SERVIDOR ===');
                console.log('Resposta completa:', JSON.stringify(data, null, 2));
                console.log('success:', data.success);
                console.log('precisa_confirmacao:', data.precisa_confirmacao, 'tipo:', typeof data.precisa_confirmacao);
                console.log('categoria_ok:', data.categoria_ok);
                console.log('categoria_nova:', data.categoria_nova);
                
                if (data.success) {
                    // Verificar se precisa confirma√ß√£o (pode ser true, 'true', ou 1)
                    const precisaConfirmacao = (!data.categoria_ok) ||
                                              data.precisa_confirmacao === true || 
                                              data.precisa_confirmacao === 'true' || 
                                              data.precisa_confirmacao === 1 ||
                                              !!data.precisa_confirmacao;
                    
                    console.log('Precisa confirma√ß√£o calculado:', precisaConfirmacao);
                    
                    if (precisaConfirmacao) {
                        // Mostrar modal de confirma√ß√£o para remanejamento
                        console.log('>>> ABRINDO MODAL <<<');
                        
                        // Garantir que temos os dados necess√°rios
                        const modalData = {
                            ...data,
                            categoria_nova: data.categoria_nova || 'N√£o dispon√≠vel',
                            limite_atual_min: data.limite_atual_min || 0,
                            limite_atual_max: data.limite_atual_max || 999,
                            limite_novo_min: data.limite_novo_min || 0,
                            limite_novo_max: data.limite_novo_max || 0
                        };
                        
                        console.log('Dados para o modal:', modalData);
                        
                        try {
                            mostrarModalRemanejamento(modalData);
                            console.log('Modal chamado com sucesso');
                        } catch (error) {
                            console.error('Erro ao chamar mostrarModalRemanejamento:', error);
                            alert('Erro ao abrir modal. Verifique o console para mais detalhes.');
                        }
                        
                        btnSubmit.disabled = false;
                        btnSubmit.textContent = originalText;
                    } else {
                        // Peso registrado com sucesso, recarregar para liberar bot√£o/estado
                        console.log("Peso dentro da categoria, recarregando.");
                        window.location.reload();
                        return;
                    }
                } else {
                    alert(data.message || 'Erro ao registrar peso.');
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                btnSubmit.disabled = false;
                btnSubmit.textContent = originalText;
                window.location.reload();
            });
        });
    });
});

function mostrarModalRemanejamento(data) {
    console.log('mostrarModalRemanejamento()', data);

    const modal = document.getElementById('modal-remanejamento');
    if (!modal) {
        console.warn('modal-remanejamento ainda n√£o existe, ignorando...');
        return;
    }

    document.removeEventListener('click', fecharModal, true);

    // Garantir ativa√ß√£o imediata
    modal.classList.add('active');
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    modal.style.zIndex = '1056';

    console.log('modal encontrado:', modal);
    console.log('display:', window.getComputedStyle(modal).display);
    console.log('Elementos do modal encontrados, configurando...');
    console.log('Modal parent:', modal.parentElement);

    const conteudo = document.getElementById('modal-conteudo');
    const form = document.getElementById('form-confirmacao');
    const acaoInput = document.getElementById('modal-acao');

    if (!conteudo || !form){
        console.error('conte√∫do do modal n√£o encontrado');
        return;
    }
    
    const formConfirmUrl = form.dataset.confirmUrl;
    form.action = data.confirm_url ||
                  formConfirmUrl ||
                  `/${data.organizacao_slug}/pesagem/inscricao/${data.inscricao_id}/confirmar-remanejamento/`;
    const pesoInput = document.getElementById('modal-peso');
    const categoriaInput = document.getElementById('modal-categoria-nova');
    
    if (pesoInput) pesoInput.value = data.peso;
    if (categoriaInput) categoriaInput.value = data.categoria_nova || '';
    if (acaoInput) acaoInput.value = 'remanejar';
    
    // Verificar se o modal est√° no DOM e vis√≠vel
    if (!document.body.contains(modal)) {
        console.error('ERRO CR√çTICO: Modal n√£o est√° no DOM!');
        console.warn('modal n√£o encontrado ainda');
        return;
    }
    
    const limiteAtual = data.limite_atual_max ? 
        `${data.limite_atual_min} a ${data.limite_atual_max} kg` : 
        `${data.limite_atual_min} kg ou mais`;
    
    const limiteNovo = data.limite_novo_max ? 
        `${data.limite_novo_min} a ${data.limite_novo_max} kg` : 
        `${data.limite_novo_min} kg ou mais`;
    
    conteudo.innerHTML = `
        <div style="margin-bottom: var(--spacing-4);">
            <p style="margin-bottom: var(--spacing-2);"><strong>Atleta:</strong> <span style="color: var(--color-gray-900);">${data.atleta_nome}</span></p>
            <p style="margin-bottom: var(--spacing-2);"><strong>Peso registrado:</strong> <span style="color: var(--color-primary); font-weight: 600;">${data.peso} kg</span></p>
        </div>
        <div style="border-top: 1px solid var(--color-gray-200); border-bottom: 1px solid var(--color-gray-200); padding: var(--spacing-4) 0; margin: var(--spacing-4) 0;">
            <p style="margin-bottom: var(--spacing-2);"><strong>Categoria atual:</strong> ${data.categoria_atual}</p>
            <p style="margin-bottom: var(--spacing-2); color: var(--color-gray-600);">Limite: ${limiteAtual}</p>
            <p style="margin-top: var(--spacing-3); margin-bottom: var(--spacing-2);"><strong>Categoria sugerida:</strong> <span style="color: var(--color-success);">${data.categoria_nova}</span></p>
            <p style="color: var(--color-gray-600);">Limite: ${limiteNovo}</p>
        </div>
        <div style="background: var(--color-danger-light); border: 1px solid var(--color-danger); border-radius: var(--border-radius-md); padding: var(--spacing-4);">
            <p style="color: #991B1B; font-weight: 600; margin-bottom: var(--spacing-2);">‚ö†Ô∏è IMPORTANTE:</p>
            <ul style="margin: 0; padding-left: var(--spacing-5); color: #991B1B;">
                <li style="margin-bottom: var(--spacing-1);">Se <strong>Remanejar</strong>: O atleta ser√° remanejado para a nova categoria e a academia <strong>perder√° 1 ponto</strong>.</li>
                <li>Se <strong>Desclassificar</strong>: O atleta ser√° desclassificado por estar fora do peso da categoria.</li>
            </ul>
        </div>
    `;
    
    console.log('Conte√∫do do modal configurado, mostrando modal...');
    
    // Prevenir scroll do body quando modal abrir
    document.body.style.overflow = 'hidden';
    
    console.log('ap√≥s active display:', window.getComputedStyle(modal).display);
    
    // FOR√áAR exibi√ß√£o do modal (solu√ß√£o robusta para conflitos de CSS)
    setTimeout(() => {
        const computedStyle = window.getComputedStyle(modal);
        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
            console.warn('‚ö†Ô∏è CSS n√£o aplicado corretamente, for√ßando exibi√ß√£o...');
            modal.style.setProperty('display', 'flex', 'important');
            modal.style.setProperty('visibility', 'visible', 'important');
            modal.style.setProperty('opacity', '1', 'important');
            modal.style.setProperty('z-index', '1055', 'important');
        }
        
        // Garantir que o modal interno tamb√©m est√° vis√≠vel
        const modalInner = modal.querySelector('.modal');
        if (modalInner) {
            modalInner.style.setProperty('display', 'block', 'important');
            modalInner.style.setProperty('visibility', 'visible', 'important');
            modalInner.style.setProperty('opacity', '1', 'important');
            modalInner.style.setProperty('z-index', '1056', 'important');
        }
    }, 10);
    
    console.log('‚úÖ Modal ativado com classe "active"');
    
    // Remover listeners anteriores e adicionar novo
    const btnDesclassificar = document.getElementById('btn-desclassificar');
    const novoBtn = btnDesclassificar.cloneNode(true);
    btnDesclassificar.parentNode.replaceChild(novoBtn, btnDesclassificar);
    
    novoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (acaoInput) acaoInput.value = 'desclassificar';
        const formData = new FormData(form);
        formData.append('acao', 'desclassificar');
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(() => {
            window.location.reload();
        });
    });

    // Bot√£o Remanejar (submit padr√£o do form)
    const btnRemanejar = document.querySelector('#form-confirmacao button[type="submit"]');
    if (btnRemanejar) {
        btnRemanejar.type = 'button';
        btnRemanejar.addEventListener('click', function(e) {
            e.preventDefault();
            if (acaoInput) acaoInput.value = 'remanejar';
            const formData = new FormData(form);
            formData.append('acao', 'remanejar');
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(() => {
                fecharModal();
                window.location.reload();
            });
        });
    }
}

// === Controle seguro do modal ===

// Fechar modal (somente quando usu√°rio clicar no bot√£o fechar)
function fecharModal() {
    const modal = document.getElementById('modal-remanejamento');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        console.log('Modal fechado manualmente');
    }
}

// Sobrescreve QUALQUER listener existente no overlay
function habilitarFechamentoSeguro() {
    const modalOverlay = document.getElementById('modal-remanejamento');
    if (!modalOverlay) return;

    // Remove todos os listeners anteriores no overlay
    const novoOverlay = modalOverlay.cloneNode(true);
    modalOverlay.parentNode.replaceChild(novoOverlay, modalOverlay);

    // Clique no pr√≥prio overlay N√ÉO fecha (evitar fechar autom√°tico)
    novoOverlay.addEventListener('click', function(event){
        // N√£o faz nada.
        event.stopPropagation();
    });

    // Clique dentro do conte√∫do tamb√©m N√ÉO fecha
    const modalContent = novoOverlay.querySelector('.modal');
    if (modalContent) {
        modalContent.addEventListener('click', function(event){
            event.stopPropagation();
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // quando a p√°gina carregar, j√° trava o fechamento autom√°tico
    habilitarFechamentoSeguro();
});

function toggleHistorico(inscricaoId) {
    const historicoDiv = document.getElementById('historico-' + inscricaoId);
    if (historicoDiv) {
        historicoDiv.style.display = historicoDiv.style.display === 'none' ? 'block' : 'none';
    }
}

// Fechar modal ao clicar no overlay (evitar propaga√ß√£o no conte√∫do do modal)
// document.addEventListener('DOMContentLoaded', function() {
//     const modalOverlay = document.getElementById('modal-remanejamento');
//     if (modalOverlay) {
//         // modalOverlay.addEventListener('click', function(e) {
//         //     if (e.target === modalOverlay) {
//         //         fecharModal();
//         //     }
//         // });
//         
//         // const modalContent = modalOverlay.querySelector('.modal');
//         // if (modalContent) {
//         //     modalContent.addEventListener('click', function(e) {
//         //         e.stopPropagation();
//         //     });
//         // }
//     }
// });

// Fun√ß√£o para abrir modal WhatsApp com dados do atleta
function abrirModalWhatsAppAtleta(telefone, nomeAcademia, academiaId, nomeAtleta, categoriaAtual, limiteCategoria, pesoAtleta, tipoNotificacao, categoriaOriginal) {
    const dadosAtleta = {
        nome: nomeAtleta,
        categoria: categoriaAtual,
        limite: limiteCategoria,
        peso: pesoAtleta,
        categoria_original: categoriaOriginal,
        categoria_nova: categoriaAtual
    };
    
    // Se j√° existe a fun√ß√£o global, usar ela
    if (typeof abrirModalWhatsApp === 'function') {
        abrirModalWhatsApp(telefone, nomeAcademia, academiaId, 'atleta', dadosAtleta);
        // Selecionar o tema correto
        setTimeout(() => {
            const tema = tipoNotificacao === 'remanejamento' ? 'remanejamento' : 'desclassificacao';
            const radio = document.querySelector(`input[name="tema-mensagem"][value="${tema}"]`);
            if (radio) {
                radio.checked = true;
                if (typeof atualizarMensagem === 'function') {
                    atualizarMensagem();
                }
            }
        }, 100);
    } else {
        // Carregar modal dinamicamente
        carregarModalWhatsApp().then(() => {
            abrirModalWhatsApp(telefone, nomeAcademia, academiaId, 'atleta', dadosAtleta);
            setTimeout(() => {
                const tema = tipoNotificacao === 'remanejamento' ? 'remanejamento' : 'desclassificacao';
                const radio = document.querySelector(`input[name="tema-mensagem"][value="${tema}"]`);
                if (radio) {
                    radio.checked = true;
                    atualizarMensagem();
                }
            }, 100);
        });
    }
}

// Carregar modal WhatsApp dinamicamente se n√£o estiver na p√°gina
function carregarModalWhatsApp() {
    return new Promise((resolve) => {
        if (document.getElementById('modal-whatsapp')) {
            resolve();
            return;
        }
        
        // Carregar o modal da lista de academias via fetch ou criar inline
        const modalHTML = `
            <!-- Modal WhatsApp -->
            <div class="modal-overlay" id="modal-whatsapp">
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <svg viewBox="0 0 24 24" fill="#25D366" style="width: 24px; height: 24px; vertical-align: middle; margin-right: var(--spacing-2);">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Enviar Mensagem WhatsApp
                        </h3>
                        <button class="modal-close" onclick="fecharModalWhatsApp()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group mb-4">
                            <label class="form-label">Destinat√°rio</label>
                            <div style="padding: var(--spacing-3); background: var(--color-gray-50); border-radius: var(--border-radius-md);">
                                <strong id="whatsapp-destinatario"></strong>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label">Tema da Mensagem</label>
                            <div style="display: grid; gap: var(--spacing-2);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="convite" checked onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">üì¢ Convite para a Copa</div>
                                        <small style="color: var(--color-gray-500);">Mensagem de convite para participar do campeonato</small>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="desclassificacao" onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">‚ö†Ô∏è Atleta Fora do Peso - Desclassifica√ß√£o</div>
                                        <small style="color: var(--color-gray-500);">Informar sobre desclassifica√ß√£o por peso</small>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); border: 2px solid var(--color-gray-200); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-base);">
                                    <input type="radio" name="tema-mensagem" value="remanejamento" onchange="atualizarMensagem()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--color-gray-900);">üîÑ Atleta Fora do Peso - Remanejamento</div>
                                        <small style="color: var(--color-gray-500);">Informar sobre remanejamento e perda de 1 ponto</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <label class="form-label" for="whatsapp-mensagem">Mensagem</label>
                            <textarea id="whatsapp-mensagem" class="form-textarea" rows="8" oninput="contarCaracteres()"></textarea>
                            <small style="display: block; margin-top: var(--spacing-1); color: var(--color-gray-500); font-size: var(--font-size-xs);">
                                Voc√™ pode editar a mensagem antes de enviar. 
                                <span id="contador-caracteres">0</span> caracteres
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fecharModalWhatsApp()">Cancelar</button>
                        <button class="btn btn-whatsapp" onclick="abrirWhatsApp()" style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Abrir WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        inicializarFuncoesWhatsApp();
        resolve();
    });
}

// Inicializar fun√ß√µes do WhatsApp se n√£o existirem
function inicializarFuncoesWhatsApp() {
    if (typeof window.whatsappData === 'undefined') {
        window.whatsappData = {
            telefone: '',
            nome: '',
            academiaId: null,
            tipo: 'academia',
            dadosAtleta: null
        };
    }
    
    if (typeof window.abrirModalWhatsApp === 'undefined') {
        window.abrirModalWhatsApp = function(telefone, nome, academiaId = null, tipo = 'academia', dadosAtleta = null) {
            window.whatsappData.telefone = telefone;
            window.whatsappData.nome = nome;
            window.whatsappData.academiaId = academiaId;
            window.whatsappData.tipo = tipo;
            window.whatsappData.dadosAtleta = dadosAtleta;
            
            document.getElementById('whatsapp-destinatario').textContent = `${nome} (${telefone})`;
            
            const radioConvite = document.querySelector('input[name="tema-mensagem"][value="convite"]');
            if (radioConvite) radioConvite.checked = true;
            
            atualizarMensagem();
            document.getElementById('modal-whatsapp').classList.add('active');
        };
    }
    
    if (typeof window.fecharModalWhatsApp === 'undefined') {
        window.fecharModalWhatsApp = function() {
            document.getElementById('modal-whatsapp').classList.remove('active');
        };
    }
    
    if (typeof window.contarCaracteres === 'undefined') {
        window.contarCaracteres = function() {
            const textarea = document.getElementById('whatsapp-mensagem');
            const contador = document.getElementById('contador-caracteres');
            if (textarea && contador) {
                contador.textContent = textarea.value.length;
            }
        };
    }
    
    if (typeof window.atualizarMensagem === 'undefined') {
        window.atualizarMensagem = function() {
            const tema = document.querySelector('input[name="tema-mensagem"]:checked')?.value || 'convite';
            const textarea = document.getElementById('whatsapp-mensagem');
            if (!textarea) return;
            
            const campeonatoNome = '{% if campeonato_ativo %}{{ campeonato_ativo.nome }}{% else %}Campeonato{% endif %}';
            const campeonatoDataInicio = '{% if campeonato_ativo and campeonato_ativo.data_inicio %}{{ campeonato_ativo.data_inicio|date:"d/m/Y" }}{% endif %}';
            const valorFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_federado %}R$ {{ campeonato_ativo.valor_inscricao_federado|floatformat:2 }}{% else %}-{% endif %}';
            const valorNaoFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_nao_federado %}R$ {{ campeonato_ativo.valor_inscricao_nao_federado|floatformat:2 }}{% else %}-{% endif %}';
            
            let mensagem = '';
            const data = window.whatsappData;
            
            if (tema === 'convite') {
                mensagem = `ü•ã *Convite para ${campeonatoNome}*\\n\\n`;
                mensagem += `Ol√°! ${data.nome}\\n\\n`;
                mensagem += `Gostar√≠amos de convidar sua academia para participar do *${campeonatoNome}*.\\n\\n`;
                if (campeonatoDataInicio) {
                    mensagem += `üìÖ *Data:* ${campeonatoDataInicio}\\n`;
                }
                mensagem += `\\nüí∞ *Valores de Inscri√ß√£o:*\\n`;
                mensagem += `‚Ä¢ Federado: ${valorFederado}\\n`;
                mensagem += `‚Ä¢ N√£o Federado: ${valorNaoFederado}\\n\\n`;
                mensagem += `Contamos com a participa√ß√£o de voc√™s!\\n\\n`;
                mensagem += `Para mais informa√ß√µes, entre em contato.`;
            } else if (tema === 'desclassificacao') {
                if (data.tipo === 'atleta' && data.dadosAtleta) {
                    const atleta = data.dadosAtleta;
                    mensagem = `‚ö†Ô∏è *Atleta Fora do Peso - Desclassifica√ß√£o*\\n\\n`;
                    mensagem += `Ol√°! Professor da ${data.nome}\\n\\n`;
                    mensagem += `Informamos que o atleta *${atleta.nome}* foi *DESCLASSIFICADO* por estar fora do peso da categoria.\\n\\n`;
                    mensagem += `üìã *Detalhes:*\\n`;
                    mensagem += `‚Ä¢ Atleta: ${atleta.nome}\\n`;
                    mensagem += `‚Ä¢ Categoria: ${atleta.categoria}\\n`;
                    mensagem += `‚Ä¢ Limite da categoria: ${atleta.limite}\\n`;
                    mensagem += `‚Ä¢ Peso registrado: ${atleta.peso} kg\\n\\n`;
                    mensagem += `O atleta est√° fora dos limites permitidos e n√£o poder√° competir nesta categoria.\\n\\n`;
                    mensagem += `Em caso de d√∫vidas, entre em contato conosco.`;
                } else {
                    mensagem = `‚ö†Ô∏è *Atleta Fora do Peso - Desclassifica√ß√£o*\\n\\n`;
                    mensagem += `Ol√°! ${data.nome}\\n\\n`;
                    mensagem += `Informamos que um atleta de sua academia foi *DESCLASSIFICADO* por estar fora do peso da categoria.\\n\\n`;
                    mensagem += `O atleta n√£o poder√° competir nesta categoria.\\n\\n`;
                    mensagem += `Para mais detalhes, acesse o sistema ou entre em contato.`;
                }
            } else if (tema === 'remanejamento') {
                if (data.tipo === 'atleta' && data.dadosAtleta) {
                    const atleta = data.dadosAtleta;
                    mensagem = `üîÑ *Atleta Fora do Peso - Remanejamento*\\n\\n`;
                    mensagem += `Ol√°! Professor da ${data.nome}\\n\\n`;
                    mensagem += `Informamos que o atleta *${atleta.nome}* foi *REMANEJADO* para outra categoria.\\n\\n`;
                    mensagem += `üìã *Detalhes:*\\n`;
                    mensagem += `‚Ä¢ Atleta: ${atleta.nome}\\n`;
                    mensagem += `‚Ä¢ Categoria original: ${atleta.categoria_original}\\n`;
                    mensagem += `‚Ä¢ Nova categoria: ${atleta.categoria_nova}\\n`;
                    mensagem += `‚Ä¢ Peso registrado: ${atleta.peso} kg\\n\\n`;
                    mensagem += `‚ö†Ô∏è *ATEN√á√ÉO:*\\n`;
                    mensagem += `Como o atleta foi remanejado, a academia *perder√° 1 ponto* no quadro geral de medalhas.\\n\\n`;
                    mensagem += `O atleta poder√° competir na nova categoria, mas este ajuste impacta a pontua√ß√£o da academia.\\n\\n`;
                    mensagem += `Em caso de d√∫vidas, entre em contato conosco.`;
                } else {
                    mensagem = `üîÑ *Atleta Fora do Peso - Remanejamento*\\n\\n`;
                    mensagem += `Ol√°! ${data.nome}\\n\\n`;
                    mensagem += `Informamos que um atleta de sua academia foi *REMANEJADO* para outra categoria.\\n\\n`;
                    mensagem += `‚ö†Ô∏è *ATEN√á√ÉO:*\\n`;
                    mensagem += `Como houve remanejamento, a academia *perder√° 1 ponto* no quadro geral de medalhas.\\n\\n`;
                    mensagem += `O atleta poder√° competir na nova categoria, mas este ajuste impacta a pontua√ß√£o da academia.\\n\\n`;
                    mensagem += `Para mais detalhes, acesse o sistema ou entre em contato.`;
                }
            }
            
            textarea.value = mensagem;
            contarCaracteres();
        };
    }
    
    if (typeof window.abrirWhatsApp === 'undefined') {
        window.abrirWhatsApp = function() {
            const textarea = document.getElementById('whatsapp-mensagem');
            const mensagem = textarea?.value || '';
            
            if (!mensagem.trim()) {
                alert('Por favor, preencha a mensagem antes de enviar.');
                return;
            }
            
            let numero = window.whatsappData.telefone.replace(/\\D/g, '');
            if (numero.length === 11 && numero[0] !== '5') {
                numero = '55' + numero;
            } else if (numero.length === 10) {
                numero = '55' + numero;
            }
            numero = numero.replace(/^550/, '55');
            
            const mensagemEncoded = encodeURIComponent(mensagem);
            const urlWhatsApp = `https://wa.me/${numero}?text=${mensagemEncoded}`;
            window.open(urlWhatsApp, '_blank');
            
            setTimeout(() => {
                fecharModalWhatsApp();
            }, 500);
        };
    }
    
    // Event listeners
    const modal = document.getElementById('modal-whatsapp');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalWhatsApp();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal?.classList.contains('active')) {
            fecharModalWhatsApp();
        }
    });
}
</script>
{% endblock %}
