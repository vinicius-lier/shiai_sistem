{% extends 'atletas/layouts/base_operational.html' %}
{% load static %}

{% block title %}Academias - Sistema de Gest√£o de Competi√ß√µes de Jud√¥{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Academias</h1>
        <p class="page-description">Gerencie todas as academias participantes</p>
    </div>
    <a href="{% url 'cadastrar_academia' organizacao_slug=request.organizacao.slug %}" class="btn btn-primary">
        <svg class="icon-16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nova Academia
    </a>
</div>

{% if academias %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Cidade</th>
                <th>Estado</th>
                <th>Telefone</th>
                <th class="text-right">Pontos</th>
                <th class="text-center">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for academia in academias %}
            <tr>
                <td>
                    <div class="flex items-center gap-3">
                        {% if academia.foto_perfil %}
                        <img src="{{ academia.foto_perfil.url }}" alt="{{ academia.nome }}" class="table-avatar">
                        {% else %}
                        <div class="table-avatar-placeholder">üè´</div>
                        {% endif %}
                        <div>
                            <div class="font-medium text-gray-900">{{ academia.nome }}</div>
                        </div>
                    </div>
                </td>
                <td class="text-sm text-gray-600">
                    {{ academia.cidade|default:"-" }}
                </td>
                <td class="text-sm text-gray-600">
                    {{ academia.estado|default:"-" }}
                </td>
                <td class="text-sm text-gray-600">
                    {% if academia.telefone %}
                        <a href="tel:{{ academia.telefone }}" class="link-primary">{{ academia.telefone }}</a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    <span class="font-semibold text-primary text-lg">{{ academia.pontos }}</span>
                    <span class="text-xs text-gray-500"> pts</span>
                </td>
                <td class="text-center">
                    <div class="table-actions-center">
                        <a href="{% url 'detalhe_academia' organizacao_slug=request.organizacao.slug academia_id=academia.id %}" class="btn btn-primary btn-xs" title="Ver detalhes">
                            <svg class="icon-14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </a>
                        <a href="{% url 'editar_academia' organizacao_slug=request.organizacao.slug academia_id=academia.id %}" class="btn btn-secondary btn-xs" title="Editar">
                            <svg class="icon-14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </a>
                        <a href="{% url 'deletar_academia' organizacao_slug=request.organizacao.slug academia_id=academia.id %}" class="btn btn-danger btn-xs" title="Excluir Academia" onclick="return confirm('Tem certeza que deseja excluir a academia {{ academia.nome }}? Esta a√ß√£o n√£o pode ser desfeita.');">
                            <svg class="icon-14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </a>
                        {% if academia.telefone %}
                            <a href="#" onclick="abrirModalWhatsApp('{{ academia.telefone }}', '{{ academia.nome }}', '{{ academia.id }}'); return false;" class="btn btn-whatsapp btn-xs" title="Enviar WhatsApp">
                                <svg class="icon-14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                            </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <div class="empty-state-title">Nenhuma academia cadastrada</div>
        <div class="empty-state-description">Comece cadastrando sua primeira academia</div>
        <a href="{% url 'cadastrar_academia' organizacao_slug=request.organizacao.slug %}" class="btn btn-primary">Cadastrar Academia</a>
    </div>
</div>
{% endif %}

<!-- Modal WhatsApp -->
<div class="modal-overlay" id="modal-whatsapp">
    <div class="modal modal--wide">
        <div class="modal-header">
            <h3 class="modal-title">
                <svg class="icon-24 modal-title-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                Enviar Mensagem WhatsApp
            </h3>
            <button class="modal-close" onclick="fecharModalWhatsApp()">
                <svg class="icon-20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group mb-4">
                <label class="form-label">Destinat√°rio</label>
                <div class="modal-highlight">
                    <strong id="whatsapp-destinatario"></strong>
                </div>
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Tema da Mensagem</label>
                <div class="option-grid">
                    <label class="option-card">
                        <input type="radio" name="tema-mensagem" value="convite" checked onchange="atualizarMensagem()">
                        <div>
                            <div class="option-card-title">üì¢ Convite para a Copa</div>
                            <small class="option-card-desc">Mensagem de convite para participar do campeonato</small>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="tema-mensagem" value="desclassificacao" onchange="atualizarMensagem()">
                        <div>
                            <div class="option-card-title">‚ö†Ô∏è Atleta Fora do Peso - Desclassifica√ß√£o</div>
                            <small class="option-card-desc">Informar sobre desclassifica√ß√£o por peso</small>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="tema-mensagem" value="remanejamento" onchange="atualizarMensagem()">
                        <div>
                            <div class="option-card-title">üîÑ Atleta Fora do Peso - Remanejamento</div>
                            <small class="option-card-desc">Informar sobre remanejamento e perda de 1 ponto</small>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group mb-4">
                <label class="form-label" for="whatsapp-mensagem">Mensagem</label>
                <textarea id="whatsapp-mensagem" class="form-textarea" rows="8" oninput="contarCaracteres()"></textarea>
                <small class="modal-helper">
                    Voc√™ pode editar a mensagem antes de enviar.
                    <span id="contador-caracteres">0</span> caracteres
                </small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharModalWhatsApp()">Cancelar</button>
            <button class="btn btn-whatsapp" onclick="abrirWhatsApp()">
                <svg class="icon-18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                Abrir WhatsApp
            </button>
        </div>
    </div>
</div>

<script>
let whatsappData = {
    telefone: '',
    nome: '',
    academiaId: null,
    tipo: 'academia' // 'academia' ou 'atleta'
};

function abrirModalWhatsApp(telefone, nome, academiaId = null, tipo = 'academia', dadosAtleta = null) {
    whatsappData.telefone = telefone;
    whatsappData.nome = nome;
    whatsappData.academiaId = academiaId;
    whatsappData.tipo = tipo;
    whatsappData.dadosAtleta = dadosAtleta;

    document.getElementById('whatsapp-destinatario').textContent = `${nome} (${telefone})`;

    // Resetar para tema padr√£o (convite)
    document.querySelector('input[name="tema-mensagem"][value="convite"]').checked = true;

    // Atualizar mensagem
    atualizarMensagem();

    // Mostrar modal
    document.getElementById('modal-whatsapp').classList.add('active');
}

function fecharModalWhatsApp() {
    document.getElementById('modal-whatsapp').classList.remove('active');
}

function contarCaracteres() {
    const textarea = document.getElementById('whatsapp-mensagem');
    const contador = document.getElementById('contador-caracteres');
    contador.textContent = textarea.value.length;
}

function atualizarMensagem() {
    const tema = document.querySelector('input[name="tema-mensagem"]:checked').value;
    const textarea = document.getElementById('whatsapp-mensagem');
    const campeonatoNome = '{% if campeonato_ativo %}{{ campeonato_ativo.nome }}{% else %}Campeonato{% endif %}';
    const campeonatoDataInicio = '{% if campeonato_ativo and campeonato_ativo.data_inicio %}{{ campeonato_ativo.data_inicio|date:"d/m/Y" }}{% endif %}';
    const valorFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_federado %}R$ {{ campeonato_ativo.valor_inscricao_federado|floatformat:2 }}{% else %}-{% endif %}';
    const valorNaoFederado = '{% if campeonato_ativo and campeonato_ativo.valor_inscricao_nao_federado %}R$ {{ campeonato_ativo.valor_inscricao_nao_federado|floatformat:2 }}{% else %}-{% endif %}';

    let mensagem = '';

    if (tema === 'convite') {
        mensagem = `Ol√° ${whatsappData.nome}! ü•ã\n\n` +
                  `Gostar√≠amos de convidar sua academia para participar do campeonato ${campeonatoNome}.\n\n` +
                  `üìÖ Data de in√≠cio: ${campeonatoDataInicio || 'a definir'}\n` +
                  `üí∞ Valores de inscri√ß√£o:\n` +
                  `‚Ä¢ Federado: ${valorFederado}\n` +
                  `‚Ä¢ N√£o federado: ${valorNaoFederado}\n\n` +
                  `Para mais informa√ß√µes e inscri√ß√µes, entre em contato conosco.\n\n` +
                  `Atenciosamente,\nEquipe SHIAI`;
    } else if (tema === 'desclassificacao') {
        mensagem = `Ol√° ${whatsappData.nome}.\n\n` +
                  `Informamos que um atleta da sua academia foi desclassificado por estar fora do peso na pesagem do campeonato ${campeonatoNome}.\n\n` +
                  `Caso tenha d√∫vidas, entre em contato com a organiza√ß√£o.\n\n` +
                  `Atenciosamente,\nEquipe SHIAI`;
    } else if (tema === 'remanejamento') {
        mensagem = `Ol√° ${whatsappData.nome}.\n\n` +
                  `Informamos que um atleta da sua academia est√° fora do peso e ser√° remanejado de categoria no campeonato ${campeonatoNome}.\n\n` +
                  `De acordo com o regulamento, haver√° perda de 1 ponto na pontua√ß√£o da academia.\n\n` +
                  `Caso tenha d√∫vidas, entre em contato.\n\n` +
                  `Atenciosamente,\nEquipe SHIAI`;
    }

    textarea.value = mensagem;
    contarCaracteres();
}

function abrirWhatsApp() {
    const mensagem = encodeURIComponent(document.getElementById('whatsapp-mensagem').value);
    const telefone = whatsappData.telefone.replace(/\D/g, '');

    if (!telefone) {
        alert('Telefone inv√°lido.');
        return;
    }

    const url = `https://wa.me/55${telefone}?text=${mensagem}`;
    window.open(url, '_blank');

    fecharModalWhatsApp();
}
</script>
{% endblock %}
