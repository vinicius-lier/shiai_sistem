<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>{% block title %}Sistema de GestÃ£o de CompetiÃ§Ãµes de JudÃ´{% endblock %}</title>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}">
    <link rel="stylesheet" href="{% static 'css/corporate.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated %}
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    <button class="theme-toggle" id="toggleTheme" onclick="toggleTheme()" title="Alternar tema">ğŸŒ“</button>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    {% endif %}
    
    <div class="wrapper">
        {% if user.is_authenticated %}
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="{% static 'img/logo.png' %}" alt="Logo FJERJ" />
                <div class="logo-text">Sistema JudÃ´</div>
            </div>
            <ul class="sidebar-menu">
                {% if user.is_authenticated and user.profile.tipo_usuario == 'academia' %}
                    {# Menu para Academia #}
                    <li class="sidebar-menu-group-title">Academia</li>
                    <li><a href="{% url 'academia_painel' %}"><span class="menu-icon">ğŸ </span><span>Painel</span></a></li>
                    <li><a href="{% url 'cadastrar_atleta' %}"><span class="menu-icon">â•</span><span>Cadastrar Atleta</span></a></li>
                    <li><a href="{% url 'lista_atletas' %}"><span class="menu-icon">ğŸ‘¥</span><span>Meus Atletas</span></a></li>
                    
                    <li class="sidebar-menu-separator"></li>
                    <li class="sidebar-menu-group-title">Eventos</li>
                    <li><a href="{% url 'eventos:eventos_disponiveis' %}"><span class="menu-icon">ğŸ“…</span><span>Eventos DisponÃ­veis</span></a></li>
                    
                    <li class="sidebar-menu-separator"></li>
                    <li class="sidebar-menu-group-title">InformaÃ§Ãµes</li>
                    <li><a href="{% url 'ranking_academias' %}"><span class="menu-icon">ğŸ†</span><span>Ranking</span></a></li>
                    <li><a href="{% url 'portal_publico' %}"><span class="menu-icon">ğŸŒ</span><span>Portal PÃºblico</span></a></li>
                {% else %}
                    {# Menu para Operacional/Admin #}
                    <li class="sidebar-menu-group-title">Institucional</li>
                    <li><a href="{% url 'index' %}"><span class="menu-icon">ğŸ </span><span>InÃ­cio</span></a></li>
                    <li><a href="{% url 'lista_academias' %}"><span class="menu-icon">ğŸ«</span><span>Academias</span></a></li>
                    <li><a href="{% url 'lista_atletas' %}"><span class="menu-icon">ğŸ‘¥</span><span>Atletas</span></a></li>
                    <li><a href="{% url 'cadastrar_atleta' %}"><span class="menu-icon">â•</span><span>Cadastrar Atleta</span></a></li>
                    
                    <li class="sidebar-menu-separator"></li>
                    <li class="sidebar-menu-group-title">Eventos</li>
                    <li><a href="{% url 'eventos:lista_eventos' %}"><span class="menu-icon">ğŸ“…</span><span>Gerenciar Eventos</span></a></li>
                    <li><a href="{% url 'lista_chaves' %}"><span class="menu-icon">ğŸ¥‹</span><span>Chaves</span></a></li>
                    <li><a href="{% url 'ranking_academias' %}"><span class="menu-icon">ğŸ†</span><span>Ranking</span></a></li>
                    <li><a href="{% url 'relatorio_atletas_inscritos' %}"><span class="menu-icon">ğŸ“„</span><span>RelatÃ³rios</span></a></li>
                    
                    <li class="sidebar-menu-separator"></li>
                    <li class="sidebar-menu-group-title">Sistema</li>
                    <li><a href="{% url 'dashboard' %}"><span class="menu-icon">ğŸ“Š</span><span>Dashboard</span></a></li>
                    {% if user.is_authenticated and user.is_superuser %}
                    <li><a href="#" onclick="abrirModalReset(); return false;" style="color: var(--danger);"><span class="menu-icon">ğŸ”„</span><span>Resetar Campeonato</span></a></li>
                    {% endif %}
                {% endif %}
                
                {% if user.is_authenticated %}
                <li class="sidebar-menu-separator"></li>
                <li><a href="{% url 'user_logout' %}"><span class="menu-icon">ğŸšª</span><span>Sair</span></a></li>
                {% endif %}
            </ul>
        </aside>
        {% endif %}
        
        <main class="main-content {% if not user.is_authenticated %}no-sidebar{% endif %}">
            <div class="page-header">
                <div class="logo-icon">
                    <img src="{% static 'img/logo.png' %}" alt="Logo 5Âº NÃºcleo" />
                </div>
                <div class="header-content">
                    <h1 class="header-title">5Âº NÃºcleo de JudÃ´ â€“ RegiÃ£o Sul Fluminense</h1>
                    <div class="header-divider"></div>
                    <p class="header-subtitle">Sistema de GestÃ£o de CompetiÃ§Ãµes de JudÃ´</p>
                </div>
                <div class="header-actions">
                    {% if user.is_authenticated %}
                        <span style="color: white; margin-right: 15px; font-size: 14px;">
                            OlÃ¡, {{ user.get_full_name|default:user.username }}
                        </span>
                        <a href="{% url 'user_logout' %}" class="btn-portal" title="Sair">
                            ğŸšª Sair
                        </a>
                    {% else %}
                        <a href="{% url 'login_tipo' %}" class="btn-portal" title="Fazer Login">
                            ğŸ” Login
                        </a>
                    {% endif %}
                    <a href="{% url 'portal_publico' %}" class="btn-portal" title="Ir para Portal PÃºblico">
                        ğŸŒ Portal PÃºblico
                    </a>
                </div>
            </div>
            <div class="container">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <!-- Modal Reset Campeonato -->
    <div id="modal-reset" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); color: var(--text); padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border);">
            <h2 style="margin-top: 0; color: var(--danger);">âš ï¸ Resetar Campeonato</h2>
            <p style="margin: 20px 0; color: var(--text-sec);">Esta aÃ§Ã£o irÃ¡:</p>
            <ul style="margin: 20px 0; padding-left: 30px; color: var(--text-sec);">
                <li>Zerar TODAS as lutas</li>
                <li>Zerar pontuaÃ§Ãµes e rankings</li>
                <li>Resetar pesagens e remanejamentos</li>
                <li>Manter atletas, academias e categorias</li>
            </ul>
            <p style="margin: 20px 0; color: var(--danger); font-weight: bold;">âš ï¸ Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
            <form id="form-reset" style="margin-top: 20px;">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                    <label for="senha-reset" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">Senha de Administrador:</label>
                    <input type="password" id="senha-reset" name="senha" required 
                           style="width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; background: var(--card-bg); color: var(--text);">
                </div>
                <div id="mensagem-reset" style="margin: 10px 0; padding: 10px; border-radius: 4px; display: none;"></div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="fecharModalReset()" class="btn-secondary">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-danger">
                        ğŸ”„ Resetar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // ============================================
    // SISTEMA DE THEMING
    // ============================================
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        let initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', initialTheme);
        updateThemeIcon(initialTheme);
        
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    updateThemeIcon(newTheme);
                }
            });
        }
    }
    
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }
    
    function updateThemeIcon(theme) {
        const toggleBtn = document.getElementById('toggleTheme');
        if (toggleBtn) {
            toggleBtn.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            toggleBtn.title = theme === 'light' ? 'Ativar tema escuro' : 'Ativar tema claro';
        }
    }
    
    initTheme();
    
    // ============================================
    // SIDEBAR TOGGLE
    // ============================================
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('open');
        if (overlay) {
            overlay.classList.toggle('active');
        }
    }
    
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggle = document.querySelector('.sidebar-toggle');
        if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.remove('open');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            }
        }
    });
    
    // ============================================
    // MODAL RESET
    // ============================================
    document.addEventListener('DOMContentLoaded', function () {
        function abrirModalReset() {
            document.getElementById('modal-reset').style.display = 'flex';
            document.getElementById('senha-reset').focus();
        }
        
        function fecharModalReset() {
            document.getElementById('modal-reset').style.display = 'none';
            document.getElementById('form-reset').reset();
            document.getElementById('mensagem-reset').style.display = 'none';
        }
        
        window.abrirModalReset = abrirModalReset;
        window.fecharModalReset = fecharModalReset;
        
        const formReset = document.getElementById('form-reset');
        if (formReset) {
            formReset.addEventListener('submit', function(e) {
                e.preventDefault();
                const senha = document.getElementById('senha-reset').value;
                const mensagem = document.getElementById('mensagem-reset');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch('{% url "reset_campeonato" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ senha: senha })
                })
                .then(async response => {
                    const data = await response.json().catch(() => ({}));
                    mensagem.style.display = 'block';
                    if (response.ok && data.detail) {
                        mensagem.style.background = 'rgba(46, 125, 50, 0.1)';
                        mensagem.style.color = 'var(--success)';
                        mensagem.style.border = '1px solid var(--success)';
                        mensagem.textContent = data.detail;
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        mensagem.style.background = 'rgba(211, 47, 47, 0.1)';
                        mensagem.style.color = 'var(--danger)';
                        mensagem.style.border = '1px solid var(--danger)';
                        mensagem.textContent = data.detail || 'Senha incorreta. AÃ§Ã£o nÃ£o autorizada.';
                    }
                })
                .catch(error => {
                    mensagem.style.display = 'block';
                    mensagem.style.background = 'rgba(211, 47, 47, 0.1)';
                    mensagem.style.color = 'var(--danger)';
                    mensagem.style.border = '1px solid var(--danger)';
                    mensagem.textContent = 'Erro ao processar requisiÃ§Ã£o';
                });
            });
        }
        
        const modalReset = document.getElementById('modal-reset');
        if (modalReset) {
            modalReset.addEventListener('click', function(e) {
                if (e.target === this) {
                    fecharModalReset();
                }
            });
        }
    });
    </script>
</body>
</html>
