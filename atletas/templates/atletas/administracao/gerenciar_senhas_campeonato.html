
{% extends 'atletas/administracao/base_admin.html' %}
{% load static %}

{% block admin_page_title %}Senhas do Campeonato - {{ campeonato.nome }}{% endblock %}
{% block admin_page_description %}Visualize e reenvie senhas de acesso para as academias{% endblock %}

{% block admin_content %}
<form method="post" id="form-marcar-enviado" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="marcar_enviado" value="1">
    <input type="hidden" name="credencial_id" id="input-academia-id">
</form>

<div style="margin-bottom: var(--spacing-6);">
    <a href="{% url 'lista_campeonatos' %}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Voltar para Campeonatos
    </a>
</div>

<section class="card mb-6">
    <div class="card-header">
        <h3 class="card-title">Informações do Campeonato</h3>
    </div>
    <div class="card-body">
        <div class="grid grid-auto-fit gap-4">
            <div>
                <p class="label-text mb-1">Nome</p>
                <p class="font-semibold text-gray-900">{{ campeonato.nome }}</p>
            </div>
            <div>
                <p class="label-text mb-1">Data da Competição</p>
                <p class="font-semibold text-gray-900">{{ data_competicao }}</p>
            </div>
            <div>
                <p class="label-text mb-1">Valor Federado</p>
                <p class="font-semibold text-gray-900">{{ valor_federado }}</p>
            </div>
            <div>
                <p class="label-text mb-1">Valor Não Federado</p>
                <p class="font-semibold text-gray-900">{{ valor_nao_federado }}</p>
            </div>
        </div>
    </div>
</section>

<section class="card">
    <div class="card-header">
        <h3 class="card-title">Senhas das Academias</h3>
        <p class="text-sm text-gray-600 m-0">
            Total: {{ academias_com_senhas|length }} academia(s)
        </p>
    </div>
    <div class="card-body">
        {% if academias_com_senhas %}
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Academia</th>
                        <th>Login</th>
                        <th>Senha do Campeonato</th>
                        <th>Telefone</th>
                        <th>Status Envio</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in academias_com_senhas %}
                    <tr>
                        <td>
                            <strong>{{ item.academia.nome }}</strong>
                            <br>
                            <small class="text-gray-500">{{ item.academia.cidade }}, {{ item.academia.estado }}</small>
                        </td>
                        <td>
                            <code style="background: var(--color-gray-100); padding: 4px 8px; border-radius: 4px; font-size: var(--font-size-sm);">{{ item.login }}</code>
                        </td>
                        <td>
                            <code style="background: var(--color-primary-light); padding: 4px 8px; border-radius: 4px; font-size: var(--font-size-sm); font-weight: 600; color: var(--color-primary);">{{ item.senha_plana }}</code>
                        </td>
                        <td>
                            {{ item.telefone|default:"Não informado" }}
                        </td>
                        <td>
                            {% if item.enviado_whatsapp %}
                            <span class="badge badge-success">Enviado</span>
                            {% if item.data_envio %}
                            <br>
                            <small style="color: var(--color-gray-500); font-size: var(--font-size-xs);">
                                {{ item.data_envio|date:"d/m/Y H:i" }}
                            </small>
                            {% endif %}
                            {% else %}
                            <span class="badge" style="background: var(--color-gray-200); color: var(--color-gray-600);">Não enviado</span>
                            {% endif %}
                        </td>
                        <td style="text-align: right;">
                            {% if item.telefone %}
                            <button type="button" 
                                    class="btn btn-secondary btn-sm btn-reenviar-senha" 
                                    data-academia="{{ item.academia.nome }}"
                                    data-login="{{ item.login }}"
                                    data-senha="{{ item.senha_plana }}"
                                    data-campeonato="{{ campeonato.nome }}"
                                    data-data="{{ data_competicao }}"
                                    data-valor-federado="{{ valor_federado }}"
                                    data-valor-nao-federado="{{ valor_nao_federado }}"
                                    data-telefone="{{ item.telefone }}"
                                    data-login-url="{% url 'academia_login' %}"
                                    data-responsavel="{{ item.responsavel|default:'' }}"
                                    data-credencial-id="{{ item.credencial_id }}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                </svg>
                                Reenviar WhatsApp
                            </button>
                            {% else %}
                            <span class="text-gray-400 text-sm">Sem telefone</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Nenhuma senha gerada para este campeonato ainda.</p>
        </div>
        {% endif %}
    </div>
</section>

<script>
function normalizarTelefone(valor) {
    if (!valor) return null;
    let numeros = valor.replace(/\D/g, '');
    if (numeros.startsWith('550')) {
        numeros = '55' + numeros.slice(3);
    }
    if (!numeros.startsWith('55') && (numeros.length === 10 || numeros.length === 11)) {
        numeros = '55' + numeros;
    }
    return numeros.length >= 12 ? numeros : null;
}

function enviarWhatsAppConvite(nomeAcademia, login, senha, nomeCampeonato, data, valorFederado, valorNaoFederado, telefone, loginUrl, responsavel) {
    const telefoneNormalizado = normalizarTelefone(telefone);
    if (!telefoneNormalizado) {
        alert('Telefone inválido.');
        return;
    }
    
    const saudacao = responsavel ? `Olá, Sensei ${responsavel}!` : 'Olá, Sensei!';
    const dataExpiracao = data ? new Date(new Date(data).getTime() + 5 * 24 * 60 * 60 * 1000) : null;
    const dataExpiracaoFormatada = dataExpiracao ? dataExpiracao.toLocaleDateString('pt-BR') : '5 dias após o término da competição';
    
    const mensagem = saudacao + '\n\n' +
        'Sensei, seguem os dados de acesso temporário ao sistema SHIAI para as inscrições deste evento:\n\n' +
        'Login: ' + login + '\n' +
        'Senha: ' + senha + '\n' +
        'Link de acesso: ' + loginUrl + '\n\n' +
        'O acesso estará disponível até 5 dias após o término da competição.';
    
    window.open('https://wa.me/' + telefoneNormalizado + '?text=' + encodeURIComponent(mensagem), '_blank');
}

// Adicionar event listeners para botões de reenvio
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-reenviar-senha').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const nomeAcademia = this.dataset.academia;
            const login = this.dataset.login;
            const senha = this.dataset.senha;
            const nomeCampeonato = this.dataset.campeonato;
            const data = this.dataset.data;
            const valorFederado = this.dataset.valorFederado;
            const valorNaoFederado = this.dataset.valorNaoFederado;
            const telefone = this.dataset.telefone;
            const loginUrl = this.dataset.loginUrl;
            const responsavel = this.dataset.responsavel;
            const credencialId = this.dataset.credencialId;
            
            // Confirmar reenvio
            if (confirm('Deseja reenviar o acesso temporário para ' + nomeAcademia + '?')) {
                enviarWhatsAppConvite(nomeAcademia, login, senha, nomeCampeonato, data, valorFederado, valorNaoFederado, telefone, loginUrl, responsavel);
                
                // Marcar como enviado via formulário
                const form = document.getElementById('form-marcar-enviado');
                const inputAcademiaId = document.getElementById('input-academia-id');
                
                if (form && inputAcademiaId && credencialId) {
                    inputAcademiaId.value = credencialId;
                    // Aguardar um pouco antes de submeter para dar tempo do WhatsApp abrir
                    setTimeout(function() {
                        form.submit();
                    }, 1000);
                }
            }
        });
    });
});
</script>
{% endblock %}

