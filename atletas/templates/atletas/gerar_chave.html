{% extends 'atletas/base.html' %}

{% block title %}Gerar Chave{% endblock %}

{% block content %}
<h1>Gerar Chave</h1>

<form method="post" id="formGerarChave">
    {% csrf_token %}
    
    <label for="classe">Classe:</label>
    <select id="classe" name="classe" required>
        <option value="">Selecione</option>
        {% for classe in classes %}
        <option value="{{ classe }}">{{ classe }}</option>
        {% endfor %}
    </select>
    
    <label for="sexo">Sexo:</label>
    <select id="sexo" name="sexo" required onchange="filtrarCategorias()">
        <option value="">Selecione</option>
        <option value="M" {% if sexo_selecionado == 'M' %}selected{% endif %}>Masculino</option>
        <option value="F" {% if sexo_selecionado == 'F' %}selected{% endif %}>Feminino</option>
    </select>
    
    <label for="categoria">Categoria:</label>
    <select id="categoria" name="categoria" required>
        <option value="">Selecione primeiro o Sexo</option>
        {% for categoria in categorias %}
        <option value="{{ categoria.categoria_nome }}">{{ categoria.label }}</option>
        {% endfor %}
    </select>
    
    <button type="button" id="btnGerarChave">Gerar Chave</button>
    <input type="hidden" name="tipo_chave" id="tipoChaveSelecionado" value="">
</form>

<!-- Modal de Sele√ß√£o de Tipo de Chave -->
<div id="modalTipoChave" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; color: #dc3545;">üìù Qual tipo de chave deseja gerar para esta categoria?</h2>
        
        <div id="infoAtletas" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>Atletas na categoria:</strong> <span id="numAtletas">-</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
            <button class="opcao-chave" data-tipo="MELHOR_DE_3" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Melhor de 3</strong><br>
                <small>(2 atletas)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="CASADA_3" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Lutas casadas 3</strong><br>
                <small>(A x B ‚Üí Perdedor x C ‚Üí Final)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="RODIZIO" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Rod√≠zio</strong><br>
                <small>(3 a 5 atletas)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="ELIMINATORIA_SIMPLES" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Eliminat√≥ria Simples</strong><br>
                <small>Mata-mata</small>
            </button>
            
            <button class="opcao-chave" data-tipo="ELIMINATORIA_REPESCAGEM" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Eliminat√≥ria + Repescagem</strong><br>
                <small>(modelo CBJ)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="OLIMPICA" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Chave Ol√≠mpica</strong><br>
                <small>(IJF)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="LIGA" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Chave Liga</strong><br>
                <small>(rod√≠zio + semifinais)</small>
            </button>
            
            <button class="opcao-chave" data-tipo="GRUPOS" style="padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; text-align: left;">
                <strong>Chave em Grupos</strong><br>
                <small>(pools)</small>
            </button>
        </div>
        
        <div style="margin-top: 20px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.9em;">
            <strong>üí° Dica:</strong> Se n√£o escolher, o sistema usar√° a l√≥gica autom√°tica baseada no n√∫mero de atletas.
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" id="btnConfirmarTipo" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Confirmar</button>
            <button type="button" id="btnCancelarTipo" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
        </div>
    </div>
</div>

<script>
let tipoChaveEscolhido = null;

function filtrarCategorias() {
    const sexo = document.getElementById('sexo').value;
    const classe = document.getElementById('classe').value;
    const categoriaSelect = document.getElementById('categoria');
    
    if (!sexo) {
        categoriaSelect.innerHTML = '<option value="">Selecione primeiro o Sexo</option>';
        return;
    }
    
    // Limpar op√ß√µes atuais
    categoriaSelect.innerHTML = '<option value="">Carregando...</option>';
    
    // Fazer requisi√ß√£o AJAX para obter categorias filtradas
    let url = '{% url "get_categorias_por_sexo" %}?sexo=' + sexo;
    if (classe) {
        url += '&classe=' + classe;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            categoriaSelect.innerHTML = '<option value="">Selecione</option>';
            data.categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nome;
                option.textContent = cat.label;
                categoriaSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao filtrar categorias:', error);
            categoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
        });
}

// Filtrar categorias quando classe mudar tamb√©m
document.addEventListener('DOMContentLoaded', function() {
    const classeSelect = document.getElementById('classe');
    if (classeSelect) {
        classeSelect.addEventListener('change', function() {
            const sexo = document.getElementById('sexo').value;
            if (sexo) {
                filtrarCategorias();
            }
        });
    }
    
    // Bot√£o Gerar Chave - abrir modal
    document.getElementById('btnGerarChave').addEventListener('click', function(e) {
        e.preventDefault();
        
        const classe = document.getElementById('classe').value;
        const sexo = document.getElementById('sexo').value;
        const categoria = document.getElementById('categoria').value;
        
        if (!classe || !sexo || !categoria) {
            alert('Preencha todos os campos (Classe, Sexo e Categoria) antes de gerar a chave.');
            return;
        }
        
        // Verificar n√∫mero de atletas antes de abrir modal
        fetch('{% url "verificar_atletas_categoria" %}?classe=' + classe + '&sexo=' + sexo + '&categoria=' + categoria)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    alert(data.erro);
                    return;
                }
                
                document.getElementById('numAtletas').textContent = data.num_atletas;
                
                // Resetar sele√ß√£o
                tipoChaveEscolhido = null;
                document.querySelectorAll('.opcao-chave').forEach(btn => {
                    btn.style.border = '2px solid #ddd';
                    btn.style.background = 'white';
                });
                
                // Mostrar modal
                document.getElementById('modalTipoChave').style.display = 'flex';
            })
            .catch(error => {
                console.error('Erro ao verificar atletas:', error);
                alert('Erro ao verificar atletas da categoria. Tente novamente.');
            });
    });
    
    // Sele√ß√£o de tipo de chave
    document.querySelectorAll('.opcao-chave').forEach(btn => {
        btn.addEventListener('click', function() {
            // Resetar sele√ß√µes
            document.querySelectorAll('.opcao-chave').forEach(b => {
                b.style.border = '2px solid #ddd';
                b.style.background = 'white';
            });
            
            // Marcar selecionado
            this.style.border = '3px solid #dc3545';
            this.style.background = '#ffe0e0';
            tipoChaveEscolhido = this.dataset.tipo;
        });
    });
    
    // Confirmar tipo
    document.getElementById('btnConfirmarTipo').addEventListener('click', function() {
        document.getElementById('tipoChaveSelecionado').value = tipoChaveEscolhido || '';
        document.getElementById('modalTipoChave').style.display = 'none';
        document.getElementById('formGerarChave').submit();
    });
    
    // Cancelar
    document.getElementById('btnCancelarTipo').addEventListener('click', function() {
        document.getElementById('modalTipoChave').style.display = 'none';
        tipoChaveEscolhido = null;
    });
});
</script>

<a href="{% url 'lista_chaves' %}" class="btn">Voltar para Lista</a>
{% endblock %}
