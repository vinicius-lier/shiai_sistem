{% extends 'atletas/base.html' %}

{% block title %}Gerar Chave{% endblock %}

{% block content %}
<h1>Gerar Chave</h1>

<form method="post">
    {% csrf_token %}
    
    <label for="classe">Classe:</label>
    <select id="classe" name="classe" required>
        <option value="">Selecione</option>
        {% for classe in classes %}
        <option value="{{ classe }}">{{ classe }}</option>
        {% endfor %}
    </select>
    
    <label for="sexo">Sexo:</label>
    <select id="sexo" name="sexo" required onchange="filtrarCategorias()">
        <option value="">Selecione</option>
        <option value="M" {% if sexo_selecionado == 'M' %}selected{% endif %}>Masculino</option>
        <option value="F" {% if sexo_selecionado == 'F' %}selected{% endif %}>Feminino</option>
    </select>
    
    <label for="categoria">Categoria:</label>
    <select id="categoria" name="categoria" required>
        <option value="">Selecione primeiro o Sexo</option>
        {% for categoria in categorias %}
        <option value="{{ categoria.categoria_nome }}">{{ categoria.label }}</option>
        {% endfor %}
    </select>
    
    <button type="submit">Gerar Chave</button>
</form>

<script>
function filtrarCategorias() {
    const sexo = document.getElementById('sexo').value;
    const classe = document.getElementById('classe').value;
    const categoriaSelect = document.getElementById('categoria');
    
    if (!sexo) {
        categoriaSelect.innerHTML = '<option value="">Selecione primeiro o Sexo</option>';
        return;
    }
    
    // Limpar opções atuais
    categoriaSelect.innerHTML = '<option value="">Carregando...</option>';
    
    // Fazer requisição AJAX para obter categorias filtradas
    let url = '{% url "get_categorias_por_sexo" %}?sexo=' + sexo;
    if (classe) {
        url += '&classe=' + classe;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            categoriaSelect.innerHTML = '<option value="">Selecione</option>';
            data.categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nome;
                option.textContent = cat.label;
                categoriaSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao filtrar categorias:', error);
            categoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
        });
}

// Filtrar categorias quando classe mudar também
document.addEventListener('DOMContentLoaded', function() {
    const classeSelect = document.getElementById('classe');
    if (classeSelect) {
        classeSelect.addEventListener('change', function() {
            const sexo = document.getElementById('sexo').value;
            if (sexo) {
                filtrarCategorias();
            }
        });
    }
});
</script>

<a href="{% url 'lista_chaves' %}" class="btn">Voltar para Lista</a>
{% endblock %}
