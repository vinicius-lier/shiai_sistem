{% extends 'atletas/base.html' %}

{% block title %}Pesagem{% endblock %}

{% block extra_css %}
<style>
@media print {
    @page {
        size: A4 landscape;
        margin: 10mm;
    }

    body {
        background: #ffffff !important;
        padding: 0;
    }

    nav,
    .filter-box,
    .btn,
    #modal-remanejamento,
    script {
        display: none !important;
    }

    .container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
    }

    h1 {
        margin: 0 0 10px 0;
        border: none;
    }
}
</style>
{% endblock %}

{% block content %}
<h1>Pesagem</h1>

<div style="margin-bottom: 15px;">
    <button type="button" class="btn" onclick="window.print()">üñ® Imprimir tela atual (com filtros)</button>
</div>


<div class="filter-box">
    <form method="get">
        <div>
            <label for="classe">Classe:</label>
            <select id="classe" name="classe">
                <option value="">Todas</option>
                {% for classe in classes %}
                <option value="{{ classe }}" {% if classe == classe_filtro %}selected{% endif %}>{{ classe }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div>
            <label for="sexo">Sexo:</label>
            <select id="sexo" name="sexo">
                <option value="">Todos</option>
                <option value="M" {% if sexo_filtro == 'M' %}selected{% endif %}>Masculino</option>
                <option value="F" {% if sexo_filtro == 'F' %}selected{% endif %}>Feminino</option>
            </select>
        </div>
        
        <div>
            <label for="categoria">Categoria:</label>
            <select id="categoria" name="categoria">
                <option value="">Todas</option>
                {% for categoria in categorias %}
                <option value="{{ categoria }}" {% if categoria == categoria_filtro %}selected{% endif %}>{{ categoria }}</option>
                {% endfor %}
            </select>
        </div>
        
        <button type="submit">Filtrar</button>
        <a href="{% url 'pesagem' %}" class="btn">Limpar Filtros</a>
    </form>
</div>

<div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Classe</th>
                <th>Sexo</th>
                <th>Categoria</th>
                <th>Limite (kg)</th>
                <th>Peso Oficial</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for atleta in atletas %}
            <tr>
                <td>{{ atleta.nome }}</td>
                <td>{{ atleta.classe }}</td>
                <td>{{ atleta.get_sexo_display }}</td>
                <td>{{ atleta.categoria_ajustada|default:atleta.categoria_nome }}</td>
                <td>{{ atleta.get_limite_categoria }}</td>
                <td>
                    {% if atleta.peso_oficial %}
                        {{ atleta.peso_oficial }} kg
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if atleta.status == 'OK' %}
                        <span class="status-ok">{{ atleta.status }}</span>
                    {% else %}
                        <span class="status-eliminado">{{ atleta.status }}</span>
                        {% if atleta.motivo_ajuste %}
                            <br><small>{{ atleta.motivo_ajuste }}</small>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <form class="form-pesagem" method="post" action="{% url 'registrar_peso' atleta.id %}" style="display: inline;" data-atleta-id="{{ atleta.id }}">
                        {% csrf_token %}
                        <input type="number" name="peso_oficial" step="0.1" min="0" placeholder="Peso (kg)" 
                               value="{% if atleta.peso_oficial %}{{ atleta.peso_oficial }}{% endif %}" 
                               style="width: 110px; display: inline-block; margin-right: 5px;" inputmode="decimal" required>
                        <button type="submit" style="padding: 8px 12px; margin: 0; min-height: 44px;">Registrar</button>
                    </form>
                    {% if 'Pode rebaixar' in atleta.motivo_ajuste %}
                    <a href="{% url 'rebaixar_categoria' atleta.id %}" class="btn btn-success" style="padding: 8px 12px; margin: 4px 0; min-height: 44px;">Rebaixar</a>
                    {% endif %}
                    {% if atleta.remanejado %}
                    <span style="color: orange; font-size: 12px; display: block; margin-top: 4px;">‚ö† Remanejado</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center;">Nenhum atleta encontrado</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Confirma√ß√£o de Remanejamento -->
<div id="modal-remanejamento" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h2 style="margin-top: 0; color: #dc3545;">‚ö† Aten√ß√£o: Peso fora da categoria!</h2>
        <div id="modal-conteudo" style="margin: 20px 0;">
            <!-- Conte√∫do ser√° preenchido via JavaScript -->
        </div>
        <form id="form-confirmacao" method="post" style="display: flex; gap: 10px; justify-content: flex-end;">
            {% csrf_token %}
            <input type="hidden" name="peso_oficial" id="modal-peso">
            <input type="hidden" name="categoria_nova" id="modal-categoria-nova">
            <button type="button" class="btn btn-danger" id="btn-desclassificar">Desclassificar</button>
            <button type="submit" name="acao" value="remanejar" class="btn btn-success">Remanejar</button>
            <button type="button" class="btn" onclick="fecharModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.form-pesagem');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const atletaId = this.dataset.atletaId;
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.precisa_confirmacao) {
                    // Mostrar modal de confirma√ß√£o
                    mostrarModalRemanejamento(data);
                } else {
                    // Recarregar p√°gina
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                window.location.reload();
            });
        });
    });
});

function mostrarModalRemanejamento(data) {
    const modal = document.getElementById('modal-remanejamento');
    const conteudo = document.getElementById('modal-conteudo');
    const form = document.getElementById('form-confirmacao');
    
    form.action = `/pesagem/${data.atleta_id}/confirmar-remanejamento/`;
    document.getElementById('modal-peso').value = data.peso;
    document.getElementById('modal-categoria-nova').value = data.categoria_nova;
    
    const limiteAtual = data.limite_atual_max ? 
        `${data.limite_atual_min} a ${data.limite_atual_max} kg` : 
        `${data.limite_atual_min} kg ou mais`;
    
    const limiteNovo = data.limite_novo_max ? 
        `${data.limite_novo_min} a ${data.limite_novo_max} kg` : 
        `${data.limite_novo_min} kg ou mais`;
    
    conteudo.innerHTML = `
        <p><strong>Atleta:</strong> ${data.atleta_nome}</p>
        <p><strong>Peso registrado:</strong> ${data.peso} kg</p>
        <hr>
        <p><strong>Categoria atual:</strong> ${data.categoria_atual} (${limiteAtual})</p>
        <p><strong>Categoria sugerida:</strong> ${data.categoria_nova} (${limiteNovo})</p>
        <hr>
        <p style="color: #dc3545;"><strong>‚ö† IMPORTANTE:</strong></p>
        <ul>
            <li>Se <strong>Remanejar</strong>: O atleta ser√° remanejado para a nova categoria e a academia <strong>perder√° 1 ponto</strong>.</li>
            <li>Se <strong>Desclassificar</strong>: O atleta ser√° desclassificado por estar fora do peso da categoria.</li>
        </ul>
    `;
    
    modal.style.display = 'flex';
    
    // Remover listeners anteriores e adicionar novo
    const btnDesclassificar = document.getElementById('btn-desclassificar');
    const novoBtn = btnDesclassificar.cloneNode(true);
    btnDesclassificar.parentNode.replaceChild(novoBtn, btnDesclassificar);
    
    novoBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        formData.append('acao', 'desclassificar');
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(() => {
            window.location.reload();
        });
    });
}

function fecharModal() {
    document.getElementById('modal-remanejamento').style.display = 'none';
}
</script>
{% endblock %}
