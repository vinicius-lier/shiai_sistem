{% extends 'atletas/base.html' %}

{% block title %}Campeonatos - Sistema de Gest√£o de Competi√ß√µes de Jud√¥{% endblock %}

{% block extra_css %}
<style>
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-4);
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal-content {
        background: var(--color-white);
        border-radius: var(--border-radius-lg);
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
        padding: var(--spacing-6);
        border-bottom: 1px solid var(--color-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: var(--font-size-2xl);
        color: var(--color-gray-400);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-sm);
    }
    
    .modal-close:hover {
        background: var(--color-gray-100);
        color: var(--color-gray-600);
    }
    
    .modal-body {
        padding: var(--spacing-6);
    }
    
    .credencial-item {
        padding: var(--spacing-4);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--border-radius-md);
        margin-bottom: var(--spacing-4);
    }
    
    .credencial-academia {
        font-weight: 600;
        color: var(--color-gray-900);
        margin-bottom: var(--spacing-2);
    }
    
    .credencial-info {
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        margin-bottom: var(--spacing-3);
    }
    
    .credencial-info strong {
        color: var(--color-gray-900);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-4);">
    <div>
        <h1 class="page-title">Campeonatos</h1>
        <p class="page-description">Gerencie os campeonatos e defina qual est√° ativo</p>
    </div>
    <a href="{% url 'cadastrar_campeonato' %}" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Novo Campeonato
    </a>
</div>

{% if campeonatos %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Data da Competi√ß√£o</th>
                <th>Data Limite de Inscri√ß√£o</th>
                <th>Status</th>
                <th style="text-align: right;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for campeonato in campeonatos %}
            <tr>
                <td>
                    <div style="font-weight: 500; color: var(--color-gray-900);">
                        {{ campeonato.nome }}
                        {% if campeonato.ativo %}
                            <span class="badge badge-success" style="margin-left: var(--spacing-2);">Ativo</span>
                        {% endif %}
                    </div>
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                    {{ campeonato.data_competicao|date:"d/m/Y"|default:"-" }}
                </td>
                <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                    {{ campeonato.data_limite_inscricao|date:"d/m/Y"|default:"-" }}
                </td>
                <td>
                    {% if campeonato.ativo %}
                        <span class="badge badge-success">Ativo</span>
                    {% else %}
                        <span class="badge" style="background: var(--color-gray-200); color: var(--color-gray-600);">Inativo</span>
                    {% endif %}
                </td>
                <td style="text-align: right;">
                    <div style="display: flex; gap: var(--spacing-2); justify-content: flex-end;">
                        <a href="{% url 'gerenciar_senhas_campeonato' campeonato.id %}" class="btn btn-secondary btn-sm" title="Ver e reenviar senhas das academias">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            Senhas
                        </a>
                        <a href="{% url 'editar_campeonato' campeonato.id %}" class="btn btn-primary btn-sm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Editar
                        </a>
                        {% if not campeonato.ativo %}
                        <a href="{% url 'definir_campeonato_ativo' campeonato.id %}" class="btn btn-secondary btn-sm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            Ativar
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
        </svg>
        <div class="empty-state-title">Nenhum campeonato cadastrado</div>
        <div class="empty-state-description">Comece criando seu primeiro campeonato</div>
        <a href="{% url 'cadastrar_campeonato' %}" class="btn btn-primary">Criar Campeonato</a>
    </div>
</div>
{% endif %}

<!-- Modal de Credenciais Geradas (Novo Sistema - Por Campeonato) -->
{% if academias_credenciais_campeonato %}
<div class="modal-overlay active" id="modal-credenciais-campeonato">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Convites para {{ campeonato_nome }}</h2>
            <button class="modal-close" onclick="fecharModalCredenciais()" aria-label="Fechar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: var(--spacing-6); color: var(--color-gray-600);">
                Clique no bot√£o WhatsApp para enviar o convite com senha de acesso para cada academia.
            </p>
            
            {% for item in academias_credenciais_campeonato %}
            <div class="credencial-item">
                <div class="credencial-academia">{{ item.academia.nome }}</div>
                <div class="credencial-info">
                    <strong>Login:</strong> {{ item.login }}<br>
                    <strong>Senha:</strong> <code style="background: var(--color-gray-100); padding: 2px 6px; border-radius: 4px; font-weight: 600;">{{ item.senha }}</code><br>
                    <strong>Telefone:</strong> {{ item.telefone|default:"N√£o informado" }}
                </div>
                {% if item.telefone %}
                <a href="javascript:void(0)" 
                   class="btn btn-secondary btn-whatsapp-convite" 
                   data-academia="{{ item.academia.nome }}"
                   data-login="{{ item.login }}"
                   data-senha="{{ item.senha }}"
                   data-campeonato="{{ campeonato_criado.nome }}"
                   data-telefone="{{ item.telefone }}"
                   data-responsavel="{{ item.responsavel|default:'' }}"
                   data-login-url="{% url 'academia_login' %}"
                   style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    Enviar Acesso via WhatsApp
                </a>
                {% else %}
                <p style="font-size: var(--font-size-sm); color: var(--color-gray-500); margin: 0; text-align: center;">
                    Telefone n√£o cadastrado - n√£o √© poss√≠vel enviar WhatsApp
                </p>
                {% endif %}
            </div>
            {% endfor %}
            
            <div style="margin-top: var(--spacing-6); padding-top: var(--spacing-6); border-top: 1px solid var(--color-gray-200);">
                <button class="btn btn-primary" onclick="fecharModalCredenciaisCampeonato()" style="width: 100%;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Credenciais Geradas (Sistema Antigo - Compatibilidade) -->
{% if academias_credenciais %}
<div class="modal-overlay active" id="modal-credenciais">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Credenciais Geradas - {{ campeonato_nome }}</h2>
            <button class="modal-close" onclick="fecharModalCredenciais()" aria-label="Fechar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: var(--spacing-6); color: var(--color-gray-600);">
                As seguintes academias tiveram login e senha gerados automaticamente. 
                Clique no bot√£o WhatsApp para enviar as credenciais.
            </p>
            
            {% for item in academias_credenciais %}
            <div class="credencial-item">
                <div class="credencial-academia">{{ item.academia.nome }}</div>
                <div class="credencial-info">
                    <strong>Login:</strong> {{ item.login }}<br>
                    <strong>Senha:</strong> {{ item.senha }}<br>
                    <strong>Telefone:</strong> {{ item.telefone|default:"N√£o informado" }}
                </div>
                {% if item.telefone %}
                <a href="javascript:void(0)" 
                   class="btn btn-secondary btn-whatsapp-credencial" 
                   data-academia="{{ item.academia.nome }}"
                   data-login="{{ item.login }}"
                   data-senha="{{ item.senha }}"
                   data-campeonato="{{ campeonato_nome }}"
                   data-telefone="{{ item.telefone }}"
                   style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    Enviar por WhatsApp
                </a>
                {% else %}
                <p style="font-size: var(--font-size-sm); color: var(--color-gray-500); margin: 0; text-align: center;">
                    Telefone n√£o cadastrado - n√£o √© poss√≠vel enviar WhatsApp
                </p>
                {% endif %}
            </div>
            {% endfor %}
            
            <div style="margin-top: var(--spacing-6); padding-top: var(--spacing-6); border-top: 1px solid var(--color-gray-200);">
                <button class="btn btn-primary" onclick="fecharModalCredenciais()" style="width: 100%;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function fecharModalCredenciais() {
    const modal = document.getElementById('modal-credenciais');
    if (modal) modal.classList.remove('active');
}

function fecharModalCredenciaisCampeonato() {
    const modal = document.getElementById('modal-credenciais-campeonato');
    if (modal) modal.classList.remove('active');
}

function normalizarTelefone(valor) {
    if (!valor) return null;
    let numeros = valor.replace(/\D/g, '');
    if (numeros.startsWith('550')) {
        numeros = '55' + numeros.slice(3);
    }
    if (!numeros.startsWith('55') && (numeros.length === 10 || numeros.length === 11)) {
        numeros = '55' + numeros;
    }
    return numeros.length >= 12 ? numeros : null;
}

// Adicionar event listeners para bot√µes WhatsApp (Sistema Antigo)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-whatsapp-credencial').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const nomeAcademia = this.dataset.academia;
            const login = this.dataset.login;
            const senha = this.dataset.senha;
            const nomeCampeonato = this.dataset.campeonato;
            const telefone = this.dataset.telefone;
            
            enviarWhatsAppCredenciais(nomeAcademia, login, senha, nomeCampeonato, telefone);
        });
    });
    
    // Adicionar event listeners para bot√µes WhatsApp (Novo Sistema - Convite)
    document.querySelectorAll('.btn-whatsapp-convite').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const nomeAcademia = this.dataset.academia;
            const login = this.dataset.login;
            const senha = this.dataset.senha;
            const nomeCampeonato = this.dataset.campeonato;
            const telefone = this.dataset.telefone;
            const loginUrl = this.dataset.loginUrl;
            const responsavel = this.dataset.responsavel || '';
            
            enviarWhatsAppConvite(nomeAcademia, login, senha, nomeCampeonato, telefone, loginUrl, responsavel);
        });
    });
});

function enviarWhatsAppCredenciais(nomeAcademia, login, senha, nomeCampeonato, telefone) {
    const telefoneNormalizado = normalizarTelefone(telefone);
    if (!telefoneNormalizado) {
        alert('Telefone inv√°lido.');
        return;
    }
    
    const loginUrl = '{{ login_url }}';
    
    const mensagem = 'Ol√°, Sensei! ü•ã\n\n' +
        'Suas credenciais de acesso para o evento *' + nomeCampeonato + '* foram geradas:\n\n' +
        'üè´ *Academia:* ' + nomeAcademia + '\n' +
        'üîë *Login:* ' + login + '\n' +
        'üîí *Senha:* ' + senha + '\n\n' +
        'Acesse o sistema atrav√©s do link:\n' +
        loginUrl + '\n\n' +
        'Escolha "Login da Academia" e use as credenciais acima.\n\n' +
        'Agradecemos pela confian√ßa! üôè';
    
    window.open('https://wa.me/' + telefoneNormalizado + '?text=' + encodeURIComponent(mensagem), '_blank');
}

function enviarWhatsAppConvite(nomeAcademia, login, senha, nomeCampeonato, telefone, loginUrl, responsavel) {
    const telefoneNormalizado = normalizarTelefone(telefone);
    if (!telefoneNormalizado) {
        alert('Telefone inv√°lido.');
        return;
    }
    
    const saudacao = responsavel ? `Ol√°, Sensei ${responsavel}!` : 'Ol√°, Sensei!';
    
    const mensagem = saudacao + '\n\n' +
        'Sensei, seguem os dados de acesso tempor√°rio ao sistema SHIAI para as inscri√ß√µes deste evento:\n\n' +
        'Login: ' + login + '\n' +
        'Senha: ' + senha + '\n' +
        'Link de acesso: ' + loginUrl + '\n\n' +
        'O acesso estar√° dispon√≠vel at√© 5 dias ap√≥s o t√©rmino da competi√ß√£o.';
    
    window.open('https://wa.me/' + telefoneNormalizado + '?text=' + encodeURIComponent(mensagem), '_blank');
}
</script>
{% endblock %}

