{% extends 'atletas/academia/base_academia.html' %}
{% load static %}

{% block title %}Inscrever Atletas - {{ campeonato.nome }}{% endblock %}

{% block extra_css %}
<style>
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-2);
        color: var(--color-primary);
        text-decoration: none;
        font-size: var(--font-size-sm);
        margin-bottom: var(--spacing-4);
        font-weight: 500;
    }

    .btn-back:hover {
        color: var(--color-primary-hover);
    }

    /* Resumo Financeiro */
    .resumo-financeiro-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-4);
    }

    @media (min-width: 480px) {
        .resumo-financeiro-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .resumo-item {
        display: flex;
        flex-direction: column;
    }

    .resumo-label {
        font-size: var(--font-size-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-1);
        font-weight: 500;
    }

    .resumo-value {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--color-gray-900);
    }

    @media (min-width: 768px) {
        .resumo-value {
            font-size: var(--font-size-2xl);
        }
    }

    .resumo-value.success {
        color: var(--color-success);
        font-size: var(--font-size-lg);
        font-weight: 600;
    }

    @media (min-width: 768px) {
        .resumo-value.success {
            font-size: var(--font-size-xl);
        }
    }

    .resumo-value.warning {
        color: var(--color-warning);
        font-size: var(--font-size-lg);
        font-weight: 600;
    }

    @media (min-width: 768px) {
        .resumo-value.warning {
            font-size: var(--font-size-xl);
        }
    }

    /* Filtros Grid */
    .filtros-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-4);
    }

    @media (min-width: 768px) {
        .filtros-grid {
            grid-template-columns: 2fr 1fr;
        }
    }

    /* Atleta Item */
    .atleta-item {
        background: var(--color-white);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-sm);
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-4);
        border-left: 4px solid var(--color-primary);
        transition: all var(--transition-base);
    }

    @media (min-width: 768px) {
        .atleta-item {
            padding: var(--spacing-6);
        }
    }

    .atleta-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .atleta-item.inscrito {
        border-left-color: var(--color-success);
        opacity: 0.9;
    }

    .atleta-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-4);
        flex-wrap: wrap;
    }

    .atleta-nome {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--color-gray-900);
        margin-bottom: var(--spacing-2);
    }

    .atleta-info {
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-1);
    }

    .atleta-info-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
    }

    /* Modal - PADR√ÉO SHIAI COM Z-INDEX CORRIGIDO */
    #modal-inscricao {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.5) !important;
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 9999 !important;
        padding: var(--spacing-4);
        backdrop-filter: blur(4px);
        visibility: hidden !important;
        opacity: 0 !important;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        margin: 0 !important;
    }

    #modal-inscricao.active {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    #modal-inscricao .modal {
        background: var(--color-white) !important;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative !important;
        z-index: 10000 !important;
        transform: scale(0.95);
        transition: transform 0.2s ease;
        margin: auto !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    #modal-inscricao.active .modal {
        transform: scale(1);
    }

    .modal-header {
        padding: var(--spacing-4);
        border-bottom: 1px solid var(--color-gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    @media (min-width: 768px) {
        .modal-header {
            padding: var(--spacing-6);
        }
    }

    .modal-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: var(--font-size-2xl);
        cursor: pointer;
        color: var(--color-gray-500);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-sm);
        transition: all var(--transition-base);
    }

    .modal-close:hover {
        background: var(--color-gray-100);
        color: var(--color-gray-900);
    }

    .modal-body {
        padding: var(--spacing-4);
    }

    @media (min-width: 768px) {
        .modal-body {
            padding: var(--spacing-6);
        }
    }

    .modal-footer {
        padding: var(--spacing-4);
        border-top: 1px solid var(--color-gray-200);
        display: flex;
        gap: var(--spacing-3);
        flex-direction: column;
    }

    @media (min-width: 480px) {
        .modal-footer {
            flex-direction: row;
            justify-content: flex-end;
        }
    }

    @media (min-width: 768px) {
        .modal-footer {
            padding: var(--spacing-6);
        }
    }

    .atleta-preview {
        padding: var(--spacing-4);
        background: var(--color-gray-50);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--color-gray-200);
    }

    .atleta-preview strong {
        display: block;
        font-size: var(--font-size-base);
        color: var(--color-gray-900);
        margin-bottom: var(--spacing-2);
    }

    .atleta-preview-info {
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        margin-bottom: var(--spacing-2);
    }

    .atleta-preview-valor {
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--color-primary);
        margin-top: var(--spacing-2);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{% url 'academia_evento' campeonato.id %}" class="btn-back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Voltar para evento
    </a>
    
    <div style="display: flex; align-items: center; gap: var(--spacing-4); margin-top: var(--spacing-4); flex-wrap: wrap;">
        {% if academia.foto_perfil %}
        <img src="{{ academia.foto_perfil.url }}" alt="{{ academia.nome }}" style="max-width: 60px; max-height: 60px; height: auto; border-radius: var(--border-radius-md); object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <img src="/static/img/logo_black.png" alt="SHIAI SISTEM" style="max-width: 60px; height: auto; display: none; flex-shrink: 0;">
        {% else %}
        <img src="/static/img/logo_black.png" alt="SHIAI SISTEM" style="max-width: 60px; height: auto; flex-shrink: 0;">
        {% endif %}
        <div style="flex: 1; min-width: 200px;">
            <h1 class="page-title" style="margin: 0;">Inscrever Atletas</h1>
            <p class="page-description" style="margin: var(--spacing-1) 0 0 0;">{{ campeonato.nome }}</p>
        </div>
    </div>
</div>

{% if prazo_inscricao_vencido %}
<div class="card mb-6" style="border-left: 4px solid var(--color-warning); background: var(--color-warning-light);">
    <div class="card-body">
        <div style="display: flex; align-items: center; gap: var(--spacing-3);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 24px; height: 24px; color: var(--color-warning); flex-shrink: 0;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <div style="flex: 1;">
                <h3 style="font-size: var(--font-size-lg); font-weight: 600; color: var(--color-gray-900); margin: 0 0 var(--spacing-1) 0;">
                    Prazo de Inscri√ß√µes Encerrado
                </h3>
                <p style="font-size: var(--font-size-sm); color: var(--color-gray-700); margin: 0;">
                    O prazo para inscri√ß√µes por academia encerrou em <strong>{{ data_limite_inscricao_academia|date:"d/m/Y" }}</strong>. 
                    Voc√™ n√£o pode mais inscrever ou editar atletas. Apenas a equipe operacional pode realizar inscri√ß√µes agora.
                </p>
            </div>
        </div>
    </div>
</div>
{% elif data_limite_inscricao_academia %}
<div class="card mb-6" style="border-left: 4px solid var(--color-info); background: var(--color-info-light);">
    <div class="card-body">
        <div style="display: flex; align-items: center; gap: var(--spacing-3);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; color: var(--color-info); flex-shrink: 0;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <p style="font-size: var(--font-size-sm); color: var(--color-gray-700); margin: 0;">
                <strong>Prazo para inscri√ß√µes:</strong> {{ data_limite_inscricao_academia|date:"d/m/Y" }}
            </p>
        </div>
    </div>
</div>
{% endif %}

{% if resumo_financeiro %}
<div class="card mb-6">
    <div class="card-body">
        <div class="resumo-financeiro-grid">
            <div class="resumo-item">
                <span class="resumo-label">Total Previsto</span>
                <div class="resumo-value">R$ {{ resumo_financeiro.valor_previsto|floatformat:2 }}</div>
            </div>
            <div class="resumo-item">
                <span class="resumo-label">Confirmado</span>
                <div class="resumo-value success">R$ {{ resumo_financeiro.valor_confirmado|floatformat:2 }}</div>
            </div>
            <div class="resumo-item">
                <span class="resumo-label">A pagar</span>
                <div class="resumo-value warning">R$ {{ resumo_financeiro.valor_pendente|floatformat:2 }}</div>
            </div>
        </div>
        <div class="mt-4" style="font-size: var(--font-size-sm); color: var(--color-gray-500); padding-top: var(--spacing-4); border-top: 1px solid var(--color-gray-200);">
            Federado: R$ {{ valor_inscricao_federado|floatformat:2 }} ‚Ä¢ N√£o federado: R$ {{ valor_inscricao_nao_federado|floatformat:2 }}
        </div>
    </div>
</div>
{% endif %}

<!-- Filtros -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">Filtros</h2>
    </div>
    <div class="card-body">
        <form method="get">
            <div class="filtros-grid">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" class="form-input" value="{{ nome_filtro }}" placeholder="Buscar por nome">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" class="form-select">
                        <option value="">Todos</option>
                        <option value="M" {% if sexo_filtro == 'M' %}selected{% endif %}>Masculino</option>
                        <option value="F" {% if sexo_filtro == 'F' %}selected{% endif %}>Feminino</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3 mt-4" style="flex-wrap: wrap;">
                <button type="submit" class="btn btn-primary">Filtrar</button>
                <a href="{% url 'academia_inscrever_atletas' campeonato.id %}" class="btn btn-secondary" style="text-decoration: none;">Limpar</a>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Atletas -->
{% if atletas %}
<div class="mb-4">
    <p class="text-gray-600" style="font-size: var(--font-size-sm);">Total: {{ atletas|length }} atleta(s)</p>
</div>
{% else %}
<div class="card" style="text-align: center; padding: var(--spacing-8);">
    <div style="margin-bottom: var(--spacing-4);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 64px; height: 64px; color: var(--color-gray-400); margin: 0 auto;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
    </div>
    <h3 style="font-size: var(--font-size-lg); font-weight: 600; color: var(--color-gray-900); margin-bottom: var(--spacing-2);">Nenhum atleta encontrado</h3>
    <p style="color: var(--color-gray-600); margin-bottom: var(--spacing-6);">
        {% if nome_filtro or sexo_filtro %}
            Nenhum atleta corresponde aos filtros aplicados. Tente ajustar os filtros ou
        {% else %}
            N√£o h√° atletas cadastrados para sua academia.
        {% endif %}
    </p>
    <div style="display: flex; gap: var(--spacing-3); justify-content: center; flex-wrap: wrap;">
        {% if nome_filtro or sexo_filtro %}
        <a href="{% url 'academia_inscrever_atletas' campeonato.id %}" class="btn btn-secondary">Limpar Filtros</a>
        {% endif %}
        <a href="{% url 'academia_cadastrar_atleta' %}?campeonato_id={{ campeonato.id }}" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Cadastrar Novo Atleta
        </a>
    </div>
</div>
{% endif %}

{% if atletas %}
<div class="grid grid-cols-1 gap-4">
    {% for item in atletas %}
    <div class="atleta-item {% if item.total_inscricoes > 0 %}inscrito{% endif %}">
        <div class="atleta-header">
            <div style="flex: 1; min-width: 0;">
                <div class="atleta-nome">{{ item.atleta.nome }}</div>
                <div class="atleta-info">
                    <div class="atleta-info-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; color: var(--color-gray-400);">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span>{{ item.atleta.get_sexo_display }} | {{ item.atleta.idade }} anos</span>
                    </div>
                    <div class="atleta-info-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; color: var(--color-gray-400);">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                            <path d="M4 22h16"></path>
                            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                        </svg>
                        <span>Classe: {{ item.atleta.get_classe_atual }}</span>
                    </div>
                    <div class="atleta-info-item" style="font-size: var(--font-size-xs); color: var(--color-gray-500); margin-top: var(--spacing-1);">
                        <span>Valor da inscri√ß√£o: </span>
                        {% if item.atleta.federado %}
                            <strong>R$ {{ valor_inscricao_federado|floatformat:2 }}</strong>
                            <span class="badge badge-info">Federado</span>
                        {% else %}
                            <strong>R$ {{ valor_inscricao_nao_federado|floatformat:2 }}</strong>
                            <span class="badge">N√£o federado</span>
                        {% endif %}
                    </div>
                    {% if item.total_inscricoes > 0 %}
                    <div style="margin-top: var(--spacing-3); padding-top: var(--spacing-3); border-top: 1px solid var(--color-gray-200);">
                        <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2); margin-bottom: var(--spacing-2);">
                            {% for insc in item.inscricoes %}
                            <span class="badge {% if insc.status_inscricao == 'aprovado' %}badge-success{% elif insc.status_inscricao == 'pendente' %}badge-warning{% else %}" style="background: var(--color-danger-light); color: #991B1B;{% endif %}">
                                {{ insc.classe_escolhida }} - {{ insc.categoria_escolhida }}
                                {% if insc.status_inscricao == 'aprovado' %}‚úì{% elif insc.status_inscricao == 'pendente' %}‚è≥{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                        <small class="text-gray-500" style="font-size: var(--font-size-xs);">
                            {{ item.total_inscricoes }} inscri√ß√£o(√µes)
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            <button type="button"
                    class="btn btn-primary"
                    data-atleta-id="{{ item.atleta.id }}"
                    onclick="{% if prazo_inscricao_vencido %}alert('O prazo para inscri√ß√µes por academia j√° encerrou. Entre em contato com a organiza√ß√£o do evento.');{% else %}abrirModalInscricao({{ item.atleta.id }}, '{{ item.atleta.nome|escapejs }}', '{{ item.atleta.get_classe_atual|escapejs }}', '{{ item.atleta.sexo }}', {{ item.atleta.federado|yesno:'true,false' }});{% endif %}"
                    style="width: 100%; min-width: 120px;"
                    {% if prazo_inscricao_vencido %}disabled title="Prazo de inscri√ß√µes encerrado"{% endif %}>
                {% if prazo_inscricao_vencido %}Prazo Encerrado{% elif item.total_inscricoes > 0 %}Adicionar{% else %}Inscrever{% endif %}
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 64px; height: 64px; color: var(--color-gray-400); margin: 0 auto var(--spacing-4);">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p class="text-gray-500" style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-4);">
                Nenhum atleta encontrado.
            </p>
            <a href="{% url 'academia_cadastrar_atleta_evento' campeonato.id %}" class="btn btn-primary" style="text-decoration: none; max-width: 300px; margin: 0 auto;">
                Cadastrar Novo Atleta
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Inscri√ß√£o - FORA DO CONTAINER PARA GARANTIR VISIBILIDADE -->
<div class="modal-overlay" id="modal-inscricao">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Inscrever Atleta</h3>
            <button class="modal-close" onclick="fecharModalInscricao()" aria-label="Fechar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form id="form-inscricao" method="post" action="{% url 'academia_inscrever_atletas' campeonato.id %}" onsubmit="return validarFormularioInscricao(event);">
            {% csrf_token %}
            <input type="hidden" id="atleta_id_inscricao" name="atleta_id">
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Atleta</label>
                    <div class="atleta-preview">
                        <strong id="atleta_nome_inscricao"></strong>
                        <div class="atleta-preview-info">
                            Classe Atual: <span id="atleta_classe_inscricao"></span> | 
                            Sexo: <span id="atleta_sexo_inscricao"></span>
                        </div>
                        <div id="valor_inscricao_preview" class="atleta-preview-valor"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="classe_escolhida">
                        Classe para Participa√ß√£o
                        <span style="color: var(--color-danger);">*</span>
                    </label>
                    <select id="classe_escolhida" name="classe_escolhida" class="form-select" required>
                        <option value="">Selecione a classe</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="categoria_escolhida" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <span>Categoria</span>
                        <span style="color: var(--color-danger);">*</span>
                        <button type="button" onclick="abrirTabelaCategorias()" style="background: none; border: none; cursor: pointer; padding: 0; margin-left: auto; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; transition: all 0.2s;" title="Ver tabela de categorias de peso" onmouseover="this.style.background='var(--color-gray-100)'" onmouseout="this.style.background='none'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; color: var(--color-warning);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                        </button>
                    </label>
                    <select id="categoria_escolhida" name="categoria_escolhida" class="form-select" required disabled>
                        <option value="">Selecione primeiro a classe</option>
                    </select>
                    <small style="display: block; margin-top: var(--spacing-1); color: var(--color-gray-500); font-size: var(--font-size-xs);">
                        D√∫vidas sobre o peso? Clique no √≠cone <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; color: var(--color-warning);"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> para ver a tabela completa
                    </small>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModalInscricao()">Cancelar</button>
                <button type="submit" class="btn btn-primary" {% if prazo_inscricao_vencido %}disabled title="Prazo de inscri√ß√µes encerrado"{% endif %}>Confirmar Inscri√ß√£o</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados das categorias
const categorias = [
    {% for cat in categorias %}
    {
        id: {{ cat.id }},
        classe: "{{ cat.classe }}",
        sexo: "{{ cat.sexo }}",
        label: "{{ cat.label }}",
        categoria_nome: "{{ cat.categoria_nome }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let atletaAtual = null;
let classeAtleta = '';
let sexoAtleta = '';
let atletaFederado = false;

const VALOR_FEDERADO = parseFloat("{{ valor_inscricao_federado|default:0 }}") || 0;
const VALOR_NAO_FEDERADO = parseFloat("{{ valor_inscricao_nao_federado|default:0 }}") || 0;
const NOVO_ATLETA_ID = "{{ novo_atleta_id|default:'' }}";

function formatarValorBR(valor) {
    return valor.toFixed(2).replace('.', ',');
}

function categoriasPermitidas(classeAtleta) {
    // Normalizar classe do atleta para compara√ß√£o
    const classeNormalizada = classeAtleta.toUpperCase().trim();
    
    // Obter classes existentes normalizadas (mantendo original para retorno)
    const classesExistentesMap = new Map();
    categorias.forEach(cat => {
        const classeNormal = cat.classe.toUpperCase().trim();
        if (!classesExistentesMap.has(classeNormal)) {
            classesExistentesMap.set(classeNormal, cat.classe); // Guarda o valor original
        }
    });
    const classesExistentesNormalizadas = Array.from(classesExistentesMap.keys());
    
    // Determinar classes permitidas baseado na classe do atleta
    // Regras de elegibilidade:
    // - VETERANOS: podem escolher VETERANOS ou S√äNIOR
    // - SUB 18: podem escolher SUB 18, SUB 21 (se existir) ou S√äNIOR
    // - Demais classes: apenas sua pr√≥pria classe
    let classesPermitidasNormalizadas = [];
    
    // Normalizar varia√ß√µes de VETERANOS
    if (classeNormalizada === 'VETERANOS' || classeNormalizada === 'VETERANO' || classeNormalizada.includes('VETERANO')) {
        // Veteranos podem escolher VETERANOS (se existir) ou S√äNIOR
        classesPermitidasNormalizadas = ['VETERANOS', 'VETERANO', 'S√äNIOR', 'SENIOR'];
    } 
    // Normalizar varia√ß√µes de SUB 18
    else if (classeNormalizada === 'SUB 18' || classeNormalizada === 'SUB18' || classeNormalizada.includes('SUB18') || classeNormalizada.includes('SUB 18')) {
        classesPermitidasNormalizadas = ['SUB 18', 'SUB 21', 'SUB21', 'S√äNIOR'];
    } 
    // Festival: apenas sua pr√≥pria classe
    else if (classeNormalizada === 'FESTIVAL') {
        classesPermitidasNormalizadas = ['FESTIVAL'];
    }
    // Regra padr√£o: apenas sua pr√≥pria classe
    else {
        classesPermitidasNormalizadas = [classeNormalizada];
    }
    
    // Filtrar apenas classes que existem no banco e retornar valores originais
    const classesFinais = [];
    classesPermitidasNormalizadas.forEach(classePermitida => {
        const classePermitidaNormal = classePermitida.toUpperCase().trim();
        // Verificar se a classe existe (compara√ß√£o flex√≠vel)
        classesExistentesMap.forEach((valorOriginal, chaveNormal) => {
            // Compara√ß√£o flex√≠vel: SUB21 = SUB 21, VETERANO = VETERANOS, S√äNIOR = SENIOR
            let match = false;
            if (chaveNormal === classePermitidaNormal) {
                match = true;
            } else if (classePermitidaNormal === 'SUB21' && (chaveNormal === 'SUB 21' || chaveNormal === 'SUB21')) {
                match = true;
            } else if (classePermitidaNormal === 'SUB 21' && (chaveNormal === 'SUB 21' || chaveNormal === 'SUB21')) {
                match = true;
            } else if (classePermitidaNormal === 'SUB18' && (chaveNormal === 'SUB 18' || chaveNormal === 'SUB18')) {
                match = true;
            } else if (classePermitidaNormal === 'SUB 18' && (chaveNormal === 'SUB 18' || chaveNormal === 'SUB18')) {
                match = true;
            } else if (classePermitidaNormal === 'VETERANO' && (chaveNormal === 'VETERANOS' || chaveNormal === 'VETERANO')) {
                match = true;
            } else if (classePermitidaNormal === 'VETERANOS' && (chaveNormal === 'VETERANOS' || chaveNormal === 'VETERANO')) {
                match = true;
            } else if (classePermitidaNormal === 'S√äNIOR' && (chaveNormal === 'S√äNIOR' || chaveNormal === 'SENIOR')) {
                match = true;
            } else if (classePermitidaNormal === 'SENIOR' && (chaveNormal === 'S√äNIOR' || chaveNormal === 'SENIOR')) {
                match = true;
            } else if (classePermitidaNormal === 'FESTIVAL' && chaveNormal === 'FESTIVAL') {
                match = true;
            }
            
            if (match && !classesFinais.includes(valorOriginal)) {
                classesFinais.push(valorOriginal);
            }
        });
    });
    
    // Caso especial: Se atleta √© VETERANO e n√£o encontrou VETERANOS no banco, 
    // mas encontrou S√äNIOR, garantir que S√äNIOR apare√ßa
    if ((classeNormalizada === 'VETERANOS' || classeNormalizada === 'VETERANO' || classeNormalizada.includes('VETERANO')) 
        && classesFinais.length > 0 && !classesFinais.some(c => c.toUpperCase().includes('VETERANO'))) {
        // Se encontrou S√äNIOR mas n√£o VETERANOS, est√° correto - manter S√äNIOR
        // Veterano pode se inscrever nas classes finais
    }
    
    // Se n√£o encontrou nenhuma classe, tentar usar a classe original do atleta
    if (classesFinais.length === 0 && classeAtleta) {
        const classeAtletaNormal = classeAtleta.toUpperCase().trim();
        classesExistentesMap.forEach((valorOriginal, chaveNormal) => {
            // Compara√ß√£o flex√≠vel para classe original
            let match = false;
            if (chaveNormal === classeAtletaNormal) {
                match = true;
            } else if ((classeAtletaNormal === 'SUB 18' || classeAtletaNormal === 'SUB18') && 
                       (chaveNormal === 'SUB 18' || chaveNormal === 'SUB18')) {
                match = true;
            } else if ((classeAtletaNormal === 'SUB 21' || classeAtletaNormal === 'SUB21') && 
                       (chaveNormal === 'SUB 21' || chaveNormal === 'SUB21')) {
                match = true;
            } else if ((classeAtletaNormal === 'VETERANOS' || classeAtletaNormal === 'VETERANO' || classeAtletaNormal.includes('VETERANO')) && 
                       (chaveNormal === 'VETERANOS' || chaveNormal === 'VETERANO' || chaveNormal === 'S√äNIOR' || chaveNormal === 'SENIOR')) {
                match = true;
            } else if (classeAtletaNormal === 'FESTIVAL' && chaveNormal === 'FESTIVAL') {
                match = true;
            }
            
            if (match && !classesFinais.includes(valorOriginal)) {
                classesFinais.push(valorOriginal);
            }
        });
    }
    
    // Retorna classes permitidas para o atleta
    
    if (classesFinais.length === 0) {
        console.warn('‚ö†Ô∏è Nenhuma classe encontrada para:', classeAtleta);
        console.log('Classes permitidas normalizadas:', classesPermitidasNormalizadas);
        console.log('Classes existentes no banco:', Array.from(classesExistentesMap.keys()));
    }
    
    return classesFinais;
}

function atualizarValorPreview() {
    const valor = atletaFederado ? VALOR_FEDERADO : VALOR_NAO_FEDERADO;
    const preview = document.getElementById('valor_inscricao_preview');
    if (preview) {
        const tipo = atletaFederado ? 'Federado' : 'N√£o federado';
        preview.textContent = `Valor da inscri√ß√£o: R$ ${formatarValorBR(valor)} (${tipo})`;
    }
}

function abrirModalInscricao(atletaId, atletaNome, classe, sexo, federado) {
    try {
        console.log('üîµ abrirModalInscricao chamado:', { atletaId, atletaNome, classe, sexo, federado });
        
        // Fun√ß√£o interna para processar ap√≥s garantir que DOM est√° pronto
        const processarModal = () => {
            atletaAtual = atletaId;
            classeAtleta = classe;
            sexoAtleta = sexo;
            atletaFederado = !!federado;
            
            // Verificar se os elementos existem antes de acess√°-los
            const atletaIdInput = document.getElementById('atleta_id_inscricao');
            const atletaNomeSpan = document.getElementById('atleta_nome_inscricao');
            const atletaClasseSpan = document.getElementById('atleta_classe_inscricao');
            const atletaSexoSpan = document.getElementById('atleta_sexo_inscricao');
            
            if (!atletaIdInput || !atletaNomeSpan || !atletaClasseSpan || !atletaSexoSpan) {
                console.error('‚ùå Elementos do formul√°rio n√£o encontrados!', {
                    atletaIdInput: !!atletaIdInput,
                    atletaNomeSpan: !!atletaNomeSpan,
                    atletaClasseSpan: !!atletaClasseSpan,
                    atletaSexoSpan: !!atletaSexoSpan,
                    modal: !!document.getElementById('modal-inscricao')
                });
                // Tentar novamente ap√≥s um pequeno delay
                setTimeout(processarModal, 50);
                return;
            }
            
            atletaIdInput.value = atletaId;
            atletaNomeSpan.textContent = atletaNome;
            atletaClasseSpan.textContent = classe;
            atletaSexoSpan.textContent = sexo === 'M' ? 'Masculino' : 'Feminino';
            atualizarValorPreview();
            
            const classesPermitidas = categoriasPermitidas(classe);
            const classeSelect = document.getElementById('classe_escolhida');
            
            if (!classeSelect) {
                console.error('‚ùå Select de classe n√£o encontrado!');
                alert('Erro: Select de classe n√£o encontrado. Recarregue a p√°gina.');
                return;
            }
            
            classeSelect.innerHTML = '<option value="">Selecione a classe</option>';
            
            if (classesPermitidas.length === 0) {
                // Se n√£o encontrou classes, mostrar mensagem de erro
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‚ö†Ô∏è Nenhuma classe dispon√≠vel. Verifique se h√° categorias cadastradas no sistema.';
                option.disabled = true;
                classeSelect.appendChild(option);
                console.error('‚ùå Nenhuma classe permitida encontrada para:', classe);
                console.log('Classes existentes no banco:', Array.from(new Map(categorias.map(c => [c.classe.toUpperCase().trim(), c.classe])).keys()));
            } else {
                classesPermitidas.forEach(classePermitida => {
                    const option = document.createElement('option');
                    option.value = classePermitida;
                    option.textContent = classePermitida;
                    if (classesPermitidas.length === 1) {
                        option.selected = true;
                        setTimeout(() => classeSelect.dispatchEvent(new Event('change')), 100);
                    }
                    classeSelect.appendChild(option);
                });
            }
            
            const categoriaSelect = document.getElementById('categoria_escolhida');
            if (!categoriaSelect) {
                console.error('‚ùå Select de categoria n√£o encontrado!');
                alert('Erro: Select de categoria n√£o encontrado. Recarregue a p√°gina.');
                return;
            }
            
            categoriaSelect.innerHTML = '<option value="">Selecione primeiro a classe</option>';
            categoriaSelect.disabled = true;
            
            const modal = document.getElementById('modal-inscricao');
            if (!modal) {
                console.error('‚ùå Modal n√£o encontrado no DOM!');
                alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
                return;
            }
            
            console.log('‚úÖ Modal encontrado, abrindo...');
            
            // Garantir que o modal est√° vis√≠vel - FOR√áAR TODAS AS PROPRIEDADES
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // For√ßar exibi√ß√£o do modal imediatamente com todas as propriedades necess√°rias
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                z-index: 9999 !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0, 0, 0, 0.5) !important;
                padding: 1rem !important;
                margin: 0 !important;
            `;
            
            // Garantir que o conte√∫do do modal tamb√©m est√° vis√≠vel
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: relative !important;
                    z-index: 10000 !important;
                    background: var(--color-white) !important;
                    border-radius: 12px !important;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
                    max-width: 500px !important;
                    width: 100% !important;
                    max-height: 90vh !important;
                    overflow-y: auto !important;
                    margin: auto !important;
                `;
            }
            
            // Verificar se o modal est√° realmente vis√≠vel ap√≥s um pequeno delay
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(modal);
                const rect = modal.getBoundingClientRect();
                console.log('üîç Estado do modal:', {
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    zIndex: computedStyle.zIndex,
                    position: computedStyle.position,
                    width: rect.width,
                    height: rect.height,
                    top: rect.top,
                    left: rect.left,
                    inViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth
                });
                
                // Se ainda n√£o estiver vis√≠vel, tentar novamente com m√©todo alternativo
                if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || parseFloat(computedStyle.opacity) < 0.5) {
                    console.log('‚ö†Ô∏è Modal ainda n√£o est√° vis√≠vel, for√ßando exibi√ß√£o novamente...');
                    modal.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        display: flex !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        z-index: 9999 !important;
                        align-items: center !important;
                        justify-content: center !important;
                        background: rgba(0, 0, 0, 0.5) !important;
                        padding: 1rem !important;
                        margin: 0 !important;
                    `;
                } else {
                    console.log('‚úÖ Modal est√° vis√≠vel e funcionando!');
                }
            }, 100);
        };
        
        // Aguardar um pouco para garantir que o DOM est√° pronto, depois processar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', processarModal);
        } else {
            // DOM j√° est√° pronto, mas dar um pequeno delay para garantir que elementos est√£o renderizados
            setTimeout(processarModal, 10);
        }
    } catch (error) {
        console.error('‚ùå Erro ao abrir modal:', error);
        alert('Erro ao abrir modal de inscri√ß√£o: ' + error.message);
    }
}

function fecharModalInscricao() {
    const modal = document.getElementById('modal-inscricao');
    if (modal) {
        // Remover classe active
        modal.classList.remove('active');
        
        // Remover todos os estilos inline que foram aplicados
        modal.style.cssText = '';
        
        // Garantir que o modal est√° oculto
        modal.style.setProperty('display', 'none', 'important');
        modal.style.setProperty('visibility', 'hidden', 'important');
        modal.style.setProperty('opacity', '0', 'important');
        
        // Remover estilos do conte√∫do do modal tamb√©m
        const modalContent = modal.querySelector('.modal');
        if (modalContent) {
            modalContent.style.cssText = '';
        }
    }
    
    // Restaurar scroll do body
    document.body.style.overflow = '';
    
    // Resetar formul√°rio
    const form = document.getElementById('form-inscricao');
    if (form) {
        form.reset();
    }
    
    // Limpar vari√°veis
    atletaAtual = null;
    
    console.log('‚úÖ Modal fechado');
}

function abrirTabelaCategorias() {
    window.open('{% url "tabela_categorias_peso" %}', 'TabelaCategorias', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

// Validar formul√°rio antes de submeter
function validarFormularioInscricao(event) {
    const atletaId = document.getElementById('atleta_id_inscricao').value;
    const classeEscolhida = document.getElementById('classe_escolhida').value;
    const categoriaEscolhida = document.getElementById('categoria_escolhida').value;
    
    if (!atletaId) {
        alert('Erro: Atleta n√£o identificado. Recarregue a p√°gina e tente novamente.');
        event.preventDefault();
        return false;
    }
    
    if (!classeEscolhida) {
        alert('Por favor, selecione a classe do atleta.');
        event.preventDefault();
        return false;
    }
    
    if (!categoriaEscolhida) {
        alert('Por favor, selecione a categoria de peso do atleta.');
        event.preventDefault();
        return false;
    }
    
    // Se tudo estiver ok, permitir submiss√£o
    return true;
}

// Tornar fun√ß√µes globais IMEDIATAMENTE para garantir acesso (DEPOIS de todas estarem definidas)
window.abrirModalInscricao = abrirModalInscricao;
window.fecharModalInscricao = fecharModalInscricao;
window.validarFormularioInscricao = validarFormularioInscricao;
window.abrirTabelaCategorias = abrirTabelaCategorias;

// Event listener para mudan√ßa de classe (aguardar DOM estar pronto)
document.addEventListener('DOMContentLoaded', function() {
    const classeSelect = document.getElementById('classe_escolhida');
    if (!classeSelect) {
        console.warn('‚ö†Ô∏è Select de classe n√£o encontrado no DOM');
        return;
    }
    
    classeSelect.addEventListener('change', function() {
    const classeSelecionada = this.value;
    const categoriaSelect = document.getElementById('categoria_escolhida');
    
    if (!classeSelecionada) {
        categoriaSelect.disabled = true;
        categoriaSelect.innerHTML = '<option value="">Selecione primeiro a classe</option>';
        return;
    }
    
    // Normalizar para compara√ß√£o
    const classeSelecionadaNormal = classeSelecionada.toUpperCase().trim();
    
    const categoriasFiltradas = categorias.filter(cat => {
        const catClasseNormal = cat.classe.toUpperCase().trim();
        return catClasseNormal === classeSelecionadaNormal && 
               cat.sexo === sexoAtleta;
    });
    
    categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
    
    if (categoriasFiltradas.length === 0) {
        categoriaSelect.disabled = true;
        categoriaSelect.innerHTML = '<option value="">Nenhuma categoria dispon√≠vel para ' + classeSelecionada + ' - ' + (sexoAtleta === 'M' ? 'Masculino' : 'Feminino') + '</option>';
    } else {
        categoriaSelect.disabled = false;
        categoriasFiltradas.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.label;  // Enviar o label completo ao inv√©s do ID
            option.setAttribute('data-categoria-id', cat.id);  // Guardar ID como atributo para refer√™ncia futura
            option.textContent = cat.label;
            categoriaSelect.appendChild(option);
        });
    }
    });
    
    // Fechar modal ao clicar fora (mas n√£o no conte√∫do do modal)
    const modal = document.getElementById('modal-inscricao');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalInscricao();
            }
        });
    } else {
        console.warn('‚ö†Ô∏è Modal n√£o encontrado no DOM');
    }
});

// Validar formul√°rio antes de submeter
function validarFormularioInscricao(event) {
    const atletaId = document.getElementById('atleta_id_inscricao').value;
    const classeEscolhida = document.getElementById('classe_escolhida').value;
    const categoriaEscolhida = document.getElementById('categoria_escolhida').value;
    
    if (!atletaId) {
        alert('Erro: Atleta n√£o identificado. Recarregue a p√°gina e tente novamente.');
        event.preventDefault();
        return false;
    }
    
    if (!classeEscolhida) {
        alert('Por favor, selecione a classe do atleta.');
        event.preventDefault();
        return false;
    }
    
    if (!categoriaEscolhida) {
        alert('Por favor, selecione a categoria de peso do atleta.');
        event.preventDefault();
        return false;
    }
    
    // Se tudo estiver ok, permitir submiss√£o
    return true;
}

// Inicializa√ß√£o quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    // Auto-abrir modal se houver novo atleta
    if (NOVO_ATLETA_ID) {
        const botao = document.querySelector(`[data-atleta-id="${NOVO_ATLETA_ID}"]`);
        if (botao) {
            setTimeout(() => botao.click(), 300);
        }
    }
});
</script>
{% endblock %}
