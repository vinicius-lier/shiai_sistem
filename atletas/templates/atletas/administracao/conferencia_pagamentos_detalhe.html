{% extends 'atletas/administracao/base_admin.html' %}

{% block admin_page_title %}Conferência de Pagamento{% endblock %}
{% block admin_page_description %}{{ academia.nome }} - {{ campeonato.nome }}{% endblock %}

{% block admin_content %}
<section class="section-spacing">
    <div class="card mb-4">
        <div class="card-header card-header-flex">
            <div>
                <h2 class="card-title m-0">{{ academia.nome }}</h2>
                <p class="text-muted mb-0 mt-1">{{ campeonato.nome }}</p>
            </div>
            <a href="{% url 'conferencia_pagamentos_lista' %}?campeonato_id={{ campeonato.id }}" class="btn btn-secondary">Voltar</a>
        </div>
        <div class="card-body">
            <!-- Resumo Financeiro -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-card-header"><span class="stat-card-title">Valor Esperado</span></div>
                        <div class="stat-card-value">R$ {{ valor_total_esperado|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-card-header"><span class="stat-card-title">Quantidade de Atletas</span></div>
                        <div class="stat-card-value">{{ qtd_atletas }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-card-header"><span class="stat-card-title">Status</span></div>
                        <div class="stat-card-value">
                            {% if conferencia %}
                                {% if conferencia.status == 'CONFIRMADO' %}
                                <span class="badge badge-success">Confirmado</span>
                                {% elif conferencia.status == 'DIVERGENTE' %}
                                <span class="badge badge-danger">Divergente</span>
                                {% elif conferencia.status == 'NAO_ENCONTRADO' %}
                                <span class="badge badge-danger">Não Encontrado</span>
                                {% else %}
                                <span class="badge badge-warning">Pendente</span>
                                {% endif %}
                            {% else %}
                                <span class="badge badge-warning">Pendente</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comprovante (se houver) -->
            {% if conferencia and conferencia.comprovante %}
            <div class="mb-4">
                <h4 class="mb-3">Comprovante de Pagamento</h4>
                <div class="p-3 bg-light rounded">
                    <a href="{{ conferencia.comprovante.url }}" target="_blank" class="btn btn-outline-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Ver Comprovante
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Lista de Inscrições -->
            <h4 class="mb-3">Inscrições</h4>
            <div class="table-container mb-4">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Atleta</th>
                            <th>Classe</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inscricoes_detalhadas %}
                        <tr>
                            <td>{{ item.atleta.nome }}</td>
                            <td>{{ item.inscricao.classe_escolhida }}</td>
                            <td>{{ item.inscricao.categoria_escolhida }}</td>
                            <td>
                                {% if item.federado %}
                                <span class="badge badge-info">Federado</span>
                                {% else %}
                                <span class="badge badge-secondary">Não Federado</span>
                                {% endif %}
                            </td>
                            <td>R$ {{ item.valor_inscricao|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end"><strong>Total:</strong></td>
                            <td><strong>R$ {{ valor_total_esperado|floatformat:2 }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Formulário de Conferência -->
            <h4 class="mb-3">Conferir Pagamento</h4>
            <form method="post" action="{% url 'conferencia_pagamentos_salvar' academia.id campeonato.id %}">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Status da Conferência <span class="text-danger">*</span></label>
                        <select class="form-select" name="status" required id="status_conferencia">
                            <option value="PENDENTE" {% if not conferencia or conferencia.status == 'PENDENTE' %}selected{% endif %}>Pendente</option>
                            <option value="CONFIRMADO" {% if conferencia and conferencia.status == 'CONFIRMADO' %}selected{% endif %}>Confirmado</option>
                            <option value="DIVERGENTE" {% if conferencia and conferencia.status == 'DIVERGENTE' %}selected{% endif %}>Divergente (Valor Incorreto)</option>
                            <option value="NAO_ENCONTRADO" {% if conferencia and conferencia.status == 'NAO_ENCONTRADO' %}selected{% endif %}>Não Encontrado</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Valor Recebido</label>
                        <input type="text" class="form-control" name="valor_recebido" 
                               value="{% if conferencia and conferencia.valor_recebido %}{{ conferencia.valor_recebido }}{% endif %}" 
                               placeholder="0,00">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Contato WhatsApp</label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="{{ contato_whatsapp }}" readonly>
                            {% if contato_whatsapp %}
                            <button type="button" class="btn btn-success" onclick="gerarMensagemWhatsApp()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                </svg>
                                Mensagem
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" rows="3" placeholder="Observações sobre a conferência...">{% if conferencia %}{{ conferencia.observacoes }}{% endif %}</textarea>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Salvar Conferência</button>
                        <a href="{% url 'conferencia_pagamentos_lista' %}?campeonato_id={{ campeonato.id }}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </div>
            </form>

            {% if conferencia and conferencia.conferido_por %}
            <div class="mt-4 p-3 bg-light rounded">
                <small class="text-muted">
                    <strong>Última conferência:</strong> {{ conferencia.data_conferencia|date:"d/m/Y H:i" }} por {{ conferencia.conferido_por.first_name|default:conferencia.conferido_por.username }}
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
function gerarMensagemWhatsApp() {
    // Pegar valores do formulário
    const status = document.querySelector('select[name="status"]').value;
    const valorRecebido = document.querySelector('input[name="valor_recebido"]').value;
    
    // Construir URL com parâmetros
    let url = '{% url "gerar_mensagem_whatsapp" academia.id campeonato.id %}?status=' + encodeURIComponent(status);
    if (valorRecebido) {
        url += '&valor_recebido=' + encodeURIComponent(valorRecebido);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.open(data.whatsapp_url, '_blank');
            } else {
                alert(data.message || 'Erro ao gerar mensagem');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao gerar mensagem do WhatsApp');
        });
}
</script>
{% endblock %}

