{% extends 'atletas/base.html' %}
{% load static %}

{% block title %}Cadastrar Atleta{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; flex-direction: column; gap: 8px;">
    <div>
        <h1 class="page-title">Cadastrar Atleta</h1>
        <p class="page-description">Equipe operacional pode cadastrar atletas para qualquer academia cadastrada.</p>
    </div>
    <a href="{% url 'lista_atletas' organizacao_slug=request.organizacao.slug %}" class="btn btn-secondary" style="align-self: flex-start;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><path d="M19 12H5"></path><polyline points="12 5 5 12 12 19"></polyline></svg>
        Voltar para lista
    </a>
</div>

{% if not academias %}
<div class="alert alert-warning" role="alert" style="margin-top: 16px;">
    Nenhuma academia ativa encontrada. Cadastre uma academia antes de adicionar atletas.
</div>
{% endif %}

<div class="card" style="margin-top: 16px;">
    <div class="card-header">
        <h3 class="card-title">Dados do atleta</h3>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome completo <span style="color: #d32f2f;">*</span></label>
                    <input type="text" id="nome" name="nome" class="form-input" placeholder="Digite o nome do atleta" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="data_nascimento">Data de nascimento <span style="color: #d32f2f;">*</span></label>
                    <input type="date" id="data_nascimento" name="data_nascimento" class="form-input" required>
                    <small class="form-hint">A classe é calculada automaticamente pelo sistema.</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="sexo">Sexo <span style="color: #d32f2f;">*</span></label>
                    <select id="sexo" name="sexo" class="form-select" required>
                        <option value="">Selecione</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="academia">Academia <span style="color: #d32f2f;">*</span></label>
                    <select id="academia" name="academia" class="form-select" required>
                        <option value="">Selecione uma academia</option>
                        {% for academia in academias %}
                        <option value="{{ academia.id }}">{{ academia.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="faixa">Faixa</label>
                    <select id="faixa" name="faixa" class="form-select">
                        <option value="">Sem informação</option>
                        <option value="BRANCA">Branca</option>
                        <option value="P.CINZA">P. Cinza</option>
                        <option value="CINZA">Cinza</option>
                        <option value="P.AZUL">P. Azul</option>
                        <option value="AZUL">Azul</option>
                        <option value="P.AMARELA">P. Amarela</option>
                        <option value="AMARELA">Amarela</option>
                        <option value="P.LARANJA">P. Laranja</option>
                        <option value="LARANJA">Laranja</option>
                        <option value="VERDE">Verde</option>
                        <option value="ROXA">Roxa</option>
                        <option value="MARRON">Marrom</option>
                        <option value="PRETA">Preta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="telefone">Telefone</label>
                    <input type="text" id="telefone" name="telefone" class="form-input" placeholder="(00) 00000-0000">
                    <small class="form-hint">Contato para conveniência.</small>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="federado" name="federado" onchange="toggleZempoField()">
                        <span>Atleta federado</span>
                    </label>
                </div>

                <div class="form-group" id="zempo-group" style="display: none;">
                    <label class="form-label" for="numero_zempo">Número Zempo</label>
                    <input type="text" id="numero_zempo" name="numero_zempo" class="form-input" placeholder="Número Zempo">
                    <small class="form-hint">Obrigatório para atletas federados.</small>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="documento_oficial">Documento oficial</label>
                    <input type="file" id="documento_oficial" name="documento_oficial" class="form-input" accept=".jpg,.jpeg,.png,.pdf,.heic">
                    <small class="form-hint">Formatos aceitos: JPG, PNG, PDF ou HEIC (máx. 5MB).</small>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="foto_perfil">Foto de perfil</label>
                    <input type="file" id="foto_perfil" name="foto_perfil" class="form-input" accept=".jpg,.jpeg,.png,.heic" onchange="previewFoto(this, 'foto-preview')">
                    <div id="foto-preview" style="margin-top: 12px; display: none;">
                        <img id="foto-preview-img" src="" alt="Preview" style="width: 120px; height: 120px; border-radius: 8px; object-fit: cover; border: 1px solid #ccc;">
                    </div>
                </div>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--color-gray-200);">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="pode_ser_equipe_tecnica" name="pode_ser_equipe_tecnica" onchange="toggleEquipeTecnicaFields()">
                    <span>Pode fazer parte da equipe técnica</span>
                </label>
                <div id="equipe-tecnica-group" style="display: none; margin-top: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="funcao_equipe_tecnica">Função / Cargo</label>
                        <input type="text" id="funcao_equipe_tecnica" name="funcao_equipe_tecnica" class="form-input" placeholder="Ex: Árbitro, Mesário">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="chave_pix">Chave PIX</label>
                        <input type="text" id="chave_pix" name="chave_pix" class="form-input" placeholder="CPF, CNPJ, e-mail, telefone ou chave aleatória">
                        <small class="form-hint">Obrigatório para pagamento da equipe técnica.</small>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <a href="{% url 'lista_atletas' organizacao_slug=request.organizacao.slug %}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Cadastrar atleta</button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleZempoField() {
    const federado = document.getElementById('federado').checked;
    const zempoGroup = document.getElementById('zempo-group');
    const zempoInput = document.getElementById('numero_zempo');
    if (federado) {
        zempoGroup.style.display = 'block';
        zempoInput.required = true;
    } else {
        zempoGroup.style.display = 'none';
        zempoInput.required = false;
        zempoInput.value = '';
    }
}

function toggleEquipeTecnicaFields() {
    const habilitado = document.getElementById('pode_ser_equipe_tecnica').checked;
    const grupo = document.getElementById('equipe-tecnica-group');
    const chavePix = document.getElementById('chave_pix');
    if (habilitado) {
        grupo.style.display = 'block';
        chavePix.required = true;
    } else {
        grupo.style.display = 'none';
        chavePix.required = false;
        chavePix.value = '';
        document.getElementById('funcao_equipe_tecnica').value = '';
    }
}

function previewFoto(input, previewId) {
    const preview = document.getElementById(previewId);
    const previewImg = document.getElementById(previewId + '-img');
    if (!input.files || !input.files[0]) {
        preview.style.display = 'none';
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(input.files[0]);
}
</script>

{% endblock %}
