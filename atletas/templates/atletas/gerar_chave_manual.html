
{% extends "atletas/layouts/base_operational.html" %}
{% load static %}

{% block title %}Gerar Lutas Casadas{% endblock %}

{% block content %}
{% include "atletas/ui/_page_head.html" with title="Gerar Lutas Casadas (Chave Manual)" subtitle="Monte uma chave manual escolhendo os atletas que irão lutar entre si" %}

<div class="action-row action-row--spaced">
  <a href="{% url 'lista_chaves' organizacao_slug=request.organizacao.slug %}" class="btn btn-secondary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg>
    Voltar
  </a>
</div>

<div class="card mb-6">
  <div class="card-header">
    <h3 class="card-title">Informação</h3>
  </div>
  <div class="card-body">
    <p style="margin: 0; color: var(--color-gray-700);">
      Use esta tela para montar uma chave manual, escolhendo os atletas que irão lutar entre si. Esta chave <strong>não conta para o ranking</strong>, é apenas para lutas casadas.
    </p>
  </div>
</div>

<div class="card mb-6">
  <div class="card-header">
    <h3 class="card-title">Filtros para facilitar seleção</h3>
  </div>
  <div class="card-body">
    <form method="get">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="nome">Nome</label>
          <input type="text" id="nome" name="nome" value="{{ nome_filtro }}" placeholder="Buscar por nome" class="form-input">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="classe">Classe</label>
          <select id="classe" name="classe" class="form-select">
            <option value="">Todas</option>
            {% for c in classes %}
              <option value="{{ c }}" {% if c == classe_filtro %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="sexo">Sexo</label>
          <select id="sexo" name="sexo" class="form-select">
            <option value="">Todos</option>
            <option value="M" {% if sexo_filtro == 'M' %}selected{% endif %}>Masculino</option>
            <option value="F" {% if sexo_filtro == 'F' %}selected{% endif %}>Feminino</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="academia">Academia</label>
          <select id="academia" name="academia" class="form-select">
            <option value="">Todas</option>
            {% for acad in academias %}
              <option value="{{ acad.id }}" {% if acad.id|stringformat:"s" == academia_filtro|stringformat:"s" %}selected{% endif %}>{{ acad.nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="action-row">
        <a href="{% url 'gerar_chave_manual' organizacao_slug=request.organizacao.slug %}" class="btn btn-secondary">Limpar Filtros</a>
        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
      </div>
    </form>
  </div>
</div>

<form method="post">
  {% csrf_token %}

  <div class="card mb-6">
    <div class="card-header">
      <h3 class="card-title">Configuração da Chave</h3>
    </div>
    <div class="card-body">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-4);">
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="nome_chave">Nome da chave</label>
          <input type="text" id="nome_chave" name="nome_chave" placeholder="Ex.: Lutas casadas SUB 11 Misto" class="form-input" required>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="classe_chave">Classe (opcional)</label>
          <input type="text" id="classe_chave" name="classe_chave" placeholder="Ex.: SUB 11" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" for="sexo_chave">Sexo da chave</label>
          <select id="sexo_chave" name="sexo_chave" class="form-select" required>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  {% if atletas %}
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="card-title">Selecione os Atletas</h3>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th style="width: 50px; text-align: center;">
                  <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>Nome</th>
                <th>Classe</th>
                <th>Sexo</th>
                <th>Categoria</th>
                <th>Faixa</th>
                <th>Academia</th>
              </tr>
            </thead>
            <tbody>
              {% for atleta in atletas %}
                <tr>
                  <td style="text-align: center;">
                    <label class="form-checkbox" style="justify-content: center;">
                      <input type="checkbox" name="atletas" value="{{ atleta.id }}" class="atleta-checkbox">
                      <span class="checkbox-indicator"></span>
                    </label>
                  </td>
                  <td><div style="font-weight: 500; color: var(--color-gray-900);">{{ atleta.nome }}</div></td>
                  <td><span class="badge badge-success">{{ atleta.get_classe_atual|default:atleta.classe_inicial|default:"SÊNIOR" }}</span></td>
                  <td>
                    <span class="badge {% if atleta.sexo == 'M' %}badge-success{% else %}badge-warning{% endif %}">
                      {{ atleta.get_sexo_display }}
                    </span>
                  </td>
                  <td style="font-size: var(--font-size-sm); color: var(--color-gray-700);">
                    {{ atleta.categoria_label|default:"-" }}
                  </td>
                  <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">{{ atleta.faixa|default:"-" }}</td>
                  <td style="font-size: var(--font-size-sm); color: var(--color-gray-600);">{{ atleta.academia.nome|default:"-" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" style="text-align: center;">Nenhum atleta encontrado com os filtros atuais</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card mb-6">
      <div class="card-body">
        <div style="display: flex; align-items: center; gap: var(--spacing-3); padding: var(--spacing-3); background: var(--color-primary-light); border-radius: var(--border-radius-md);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 24px; height: 24px; flex-shrink: 0;">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4M12 8h.01"></path>
          </svg>
          <p style="margin: 0; color: var(--color-gray-700); font-size: var(--font-size-sm);">
            Os atletas serão pareados em ordem de seleção: 1 x 2, 3 x 4, 5 x 6, etc. Se houver atleta sobrando, ele ficará em WO.
          </p>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <a href="{% url 'lista_chaves' organizacao_slug=request.organizacao.slug %}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
        Gerar Lutas Casadas
      </button>
    </div>
  {% else %}
    <div class="card">
      <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
        </svg>
        <div class="empty-state-title">Nenhum atleta encontrado</div>
        <div class="empty-state-description">Nenhum atleta corresponde aos filtros aplicados. Tente ajustar os filtros acima.</div>
      </div>
    </div>
  {% endif %}
</form>

<script>
  // UX-only: seleção em lote (sem regras de negócio)
  function toggleSelectAll(checkbox) {
    document.querySelectorAll('.atleta-checkbox').forEach(cb => { cb.checked = checkbox.checked; });
  }

  document.querySelectorAll('.atleta-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      const selectAll = document.getElementById('select-all');
      if (!selectAll) return;
      const all = document.querySelectorAll('.atleta-checkbox');
      const checked = document.querySelectorAll('.atleta-checkbox:checked');
      selectAll.checked = (all.length > 0 && all.length === checked.length);
    });
  });
</script>

{% endblock %}
